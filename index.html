<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Michawaro – Apprendre, Enseigner, Partager</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        font-family: "Fredoka", sans-serif;
        background-color: #f5f5f5;
        color: #333;
      }

      header {
        background: linear-gradient(135deg, #e84e9b 40%, #89d6e2 100%);
        color: white;
        padding: 30px 10px;
        text-align: center;
      }

      header h1 {
        font-size: 2.8em;
        margin: 0;
        letter-spacing: 2px;
      }

      header p {
        font-size: 1.2em;
        margin-top: 10px;
        color: #fce86e;
      }

      main {
        padding: 30px 5vw;
      }

      table {
        width: 90vw;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        table-layout: fixed;
        border: 2px solid #bdbdbd;
      }

      th,
      td {
        padding: 7px 6px;
        border-bottom: 2px solid #bdbdbd;
        border-right: 2px solid #bdbdbd;
        text-align: center;
        vertical-align: middle;
        overflow-wrap: break-word;
        resize: horizontal;
        overflow: auto;
      }

      th:last-child,
      td:last-child {
        border-right: none;
      }

      tr:last-child td {
        border-bottom: none;
      }

      th {
        background-color: #89d6e2;
        color: white;
        user-select: none;
      }

      td[contenteditable="true"] {
        background-color: #fffdf5;
        white-space: pre-wrap;
      }

      tr:hover {
        background-color: #fef0f7;
      }

      .resource-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-end;
        gap: 8px;
        padding: 0;
        margin: 0;
        background: #fafafa;
        border-radius: 6px;
      }

      .resource-block {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        max-width: 140px;
        background: #fff;
        padding: 0;
        border: 1px solid #ccc;
        border-radius: 6px;
        transition: box-shadow 0.3s;
        flex-grow: 1;
        margin: 0;
        max-height: 180px;
        height: 180px;
        overflow: hidden;
      }

      .resource-img {
        max-width: 100%;
        max-height: 110px;
        height: auto;
        object-fit: contain;
        border-radius: 4px;
        margin: 0;
        padding: 0;
        display: block;
      }

      /* Réduction de 30% de la taille des vignettes YouTube */
      .thumb {
        width: 70%; /* Réduction de 30% (100% - 30% = 70%) */
        height: auto;
        border-radius: 6px;
        display: block;
        margin: 0 auto;
      }

      .delete-btn {
        position: absolute;
        top: 3px; /* Ajustement pour centrer verticalement */
        right: 3px; /* Ajustement pour centrer horizontalement */
        background: rgba(255, 255, 255, 0.9); /* Blanc avec opacité réduite */
        color: red; /* Couleur de la croix */
        border: none;
        border-radius: 50%;
        width: 16px; /* Taille réduite */
        height: 16px;
        font-size: 10px; /* Taille de la croix */
        font-weight: bold; /* Rendre la croix plus visible */
        display: flex; /* Utilisation de flexbox */
        align-items: center; /* Centrer verticalement */
        justify-content: center; /* Centrer horizontalement */
        cursor: pointer;
        display: none; /* Caché par défaut */
        transition: background-color 0.3s, transform 0.2s;
      }

      .delete-btn:hover {
        background: rgba(255, 255, 255, 1); /* Blanc vif au survol */
        color: darkred; /* Couleur de la croix au survol */
        transform: scale(1.1); /* Légère mise en avant au survol */
      }

      .resource-block:hover .delete-btn {
        display: flex; /* Affiché uniquement au survol de la ressource */
      }

      .resource-block {
        position: relative;
        flex-direction: column;
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 140px;
        background: #fff;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 6px;
        transition: box-shadow 0.3s;
      }

      .resource-block:hover {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* Effet visuel au survol */
      }

      .image-title {
        margin: 0;
        padding: 0;
        font-size: 0.85em;
        text-align: center;
        outline: none;
        width: 100%;
        color: black;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .resource-title {
        font-size: 0.9em;
        font-weight: bold;
        width: 100%;
        text-align: center;
        outline: none;
        color: black;
        margin: 0;
        padding: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .resource-title-wrapper {
        width: 100%;
        text-align: center;
        margin: 0;
        padding: 0;
        position: relative;
      }

      .drop-zone {
        font-size: 0.85em;
        color: #999;
        width: 100%;
        text-align: center;
        margin: 0;
        padding: 0;
        min-height: 0;
      }

      .form-container {
        margin-top: 30px;
        background: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      .form-container input {
        padding: 10px;
        margin-right: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        width: 18%;
      }

      .form-container button {
        padding: 10px 20px;
        border: none;
        background-color: #e84e9b;
        color: white;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
      }

      .form-container button:hover {
        background-color: #d13b88;
      }

      @media (max-width: 768px) {
        td,
        th {
          font-size: 0.9em;
          padding: 8px;
        }

        .form-container input {
          width: 100%;
          margin-bottom: 10px;
        }
      }
      .edit-icon {
        cursor: pointer;
        display: none;
        margin-top: 5px;
        color: #999;
        font-size: 12px;
      }
    </style>
  </head>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    const SUPABASE_URL = "https://nfqaijeeozypkvkrxfwh.supabase.co"; // Remplace par ton URL
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mcWFpamVlb3p5cGt2a3J4ZndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDAzMDUsImV4cCI6MjA2ODQxNjMwNX0.6z0kRlR_qUSxP_jPngOfF1mcNbiMZBS3RsategLrjxo"; // Clé publique (anonyme) — attention à la config RLS

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function saveToSupabase() {
      const userIdElement = document.getElementById("userId");
      if (!userIdElement) {
        console.warn("Élément userId non trouvé");
        return;
      }

      const userId = userIdElement.value.trim();

      // Récupérer toutes les lignes de la table
      const rows = [...tbody.querySelectorAll("tr")];

      // Préparer les nouvelles données
      const videosData = rows.map((row, index) => {
        const videoLink = row.querySelector("td a")?.href || "";

        // Récupérer les données des ressources et les convertir en JSON
        const ressourcesCell = row.cells[3];
        const resourceContainer = ressourcesCell.querySelector(
          ".resource-container"
        );

        let ressourcesJSON = {
          titre: "",
          images: [],
        };

        if (resourceContainer) {
          // Récupérer le titre principal
          const titreElement =
            resourceContainer.querySelector(".resource-title");
          if (titreElement) {
            ressourcesJSON.titre = titreElement.innerHTML || "";
          }

          // Récupérer les images et leurs titres
          const imageBlocks =
            resourceContainer.querySelectorAll(".resource-block");
          imageBlocks.forEach((block) => {
            const img = block.querySelector("img");
            const caption = block.querySelector(".image-title");

            if (img && caption) {
              ressourcesJSON.images.push({
                src: img.src, // Base64 de l'image
                titre: caption.innerHTML || "",
              });
            }
          });
        }

        return {
          user_id: userId,
          video_url: videoLink,
          niveau: row.cells[1].innerHTML,
          contenu: row.cells[2].innerHTML,
          ressources: ressourcesJSON, // Structure JSON
          ordre: index,
        };
      });

      // LOG pour diagnostic
      console.log(
        "Données à sauvegarder :",
        JSON.stringify(videosData, null, 2)
      );

      // Sauvegarde incrémentale optimisée pour multi-supports
      if (videosData.length > 0) {
        let successCount = 0;
        let errorCount = 0;

        for (const videoData of videosData) {
          // LOG pour chaque vidéo
          console.log("Vidéo à sauvegarder :", videoData);
          // Vérifier si la vidéo existe déjà pour cet utilisateur
          const { data: existingData } = await supabaseClient
            .from("videos")
            .select("id")
            .eq("user_id", userId)
            .eq("video_url", videoData.video_url)
            .single();

          if (existingData) {
            // Mettre à jour la vidéo existante
            const { error: updateError } = await supabaseClient
              .from("videos")
              .update({
                niveau: videoData.niveau,
                contenu: videoData.contenu,
                ressources: videoData.ressources, // Structure JSON
                ordre: videoData.ordre,
              })
              .eq("id", existingData.id);

            if (updateError) {
              console.error(
                "Erreur lors de la mise à jour:",
                updateError.message
              );
              errorCount++;
            } else {
              successCount++;
            }
          } else {
            // Insérer une nouvelle vidéo
            const { error: insertError } = await supabaseClient
              .from("videos")
              .insert(videoData);

            if (insertError) {
              console.error("Erreur lors de l'insertion:", insertError.message);
              errorCount++;
            } else {
              successCount++;
            }
          }
        }

        if (errorCount > 0) {
          console.warn(`${errorCount} erreurs lors de la sauvegarde`);
        }

        if (successCount > 0) {
          console.log(`${successCount} vidéos sauvegardées avec succès`);
        }
      }
    }

    async function loadFromSupabase() {
      const userIdElement = document.getElementById("userId");
      if (!userIdElement) {
        console.warn("Élément userId non trouvé");
        return;
      }

      const userId = userIdElement.value.trim();

      // Charger les données pour cet utilisateur spécifique
      const { data, error } = await supabaseClient
        .from("videos")
        .select("video_url, niveau, contenu, ressources, ordre")
        .eq("user_id", userId)
        .order("ordre", { ascending: true, nullsFirst: true });

      // LOG pour diagnostic
      console.log("Données chargées depuis Supabase :", data);

      if (error) {
        console.warn("Pas de données Supabase ou erreur :", error.message);
        return;
      }

      tbody.innerHTML = "";
      data.forEach((item) => {
        // Convertir les ressources JSON en HTML
        let ressourcesHTML =
          '<div class="resource-container"><div class="resource-title-wrapper"><div class="resource-title" contenteditable="true">Titre</div></div><div class="drop-zone"></div></div>';

        if (item.ressources && typeof item.ressources === "object") {
          // Reconstruire le HTML à partir des données JSON
          ressourcesHTML = '<div class="resource-container">';

          // Titre principal
          if (item.ressources.titre) {
            ressourcesHTML += `<div class="resource-title-wrapper"><div class="resource-title" contenteditable="true">${item.ressources.titre}</div></div>`;
          } else {
            ressourcesHTML +=
              '<div class="resource-title-wrapper"><div class="resource-title" contenteditable="true">Titre</div></div>';
          }

          // Images
          if (item.ressources.images && item.ressources.images.length > 0) {
            item.ressources.images.forEach((image) => {
              ressourcesHTML += `
                <div class="resource-block">
                  <button class="delete-btn" onclick="this.parentElement.remove(); saveTable();">❌</button>
                  <img src="${image.src}" class="resource-img" alt="Ressource">
                  <div class="image-title" contenteditable="true">${image.titre}</div>
                </div>
              `;
            });
          }

          ressourcesHTML += '<div class="drop-zone"></div></div>';
        }

        insertRow(item.video_url, item.niveau, item.contenu, ressourcesHTML);
        // Ajout des écouteurs focusout sur les titres après l'injection HTML
        const lastRow = tbody.lastElementChild;
        if (lastRow) {
          const resourceTitle = lastRow.querySelector(".resource-title");
          if (resourceTitle) {
            resourceTitle.addEventListener("focusout", saveTable);
          }
          const imageTitles = lastRow.querySelectorAll(".image-title");
          imageTitles.forEach((caption) => {
            caption.addEventListener("focusout", saveTable);
          });
        }
      });

      // Appliquer les restrictions d'édition après le chargement
      disableEditing();
    }

    // Remplace ou complète la logique existante :
    async function saveTable() {
      await saveToSupabase();
    }
    async function loadTable() {
      await loadFromSupabase();
    }
  </script>

  <body>
    <header>
      <h1>MICHAWARO</h1>
      <p>Apprendre, Enseigner, Partager</p>
    </header>

    <!-- À placer juste avant la balise <main> ou juste après <header> -->

    <div
      style="
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: flex-end;
        margin: 10px 5vw 0 0;
      "
    >
      <input
        type="text"
        id="userId"
        value="michawaro4480"
        placeholder="Identifiant"
        style="
          padding: 6px 10px;
          border-radius: 6px;
          border: 1px solid #ccc;
          font-family: inherit;
          font-size: 1em;
          width: 160px;
          display: none;
        "
      />
      <button
        id="connectBtn"
        style="
          background: #89d6e2;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 7px 16px;
          font-weight: bold;
          cursor: pointer;
          font-family: inherit;
          font-size: 1em;
        "
      >
        Connexion
      </button>
      <button
        id="saveBtn"
        style="
          background: #e84e9b;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 7px 16px;
          font-weight: bold;
          cursor: pointer;
          font-family: inherit;
          font-size: 1em;
        "
      >
        💾 Sauvegarder
      </button>
    </div>

    <!-- Cartouche de filtre Niveau + Contenu -->
    <div
      id="niveau-filter"
      style="
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        padding: 18px 28px;
        margin: 18px 5vw 10px 5vw;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        font-family: inherit;
        font-size: 1.08em;
        color: #333;
        width: fit-content;
      "
    >
      <div
        style="
          width: calc(100% + 56px); /* pour couvrir le padding horizontal */
          margin-left: -28px;
          margin-top: -18px;
          margin-bottom: 12px;
          padding: 12px 0;
          background: linear-gradient(135deg, #e84e9b 40%, #fce86e 100%);
          color: white;
          border-radius: 12px 12px 0 0;
          text-align: center;
          font-weight: bold;
          font-size: 1.15em;
          letter-spacing: 2px;
        "
      >
        FILTRES
      </div>
      <div
        style="
          display: flex;
          align-items: center;
          gap: 18px;
          margin-bottom: 2px;
        "
      >
        <span style="font-weight: bold; margin-right: 10px">Niveau :</span>
        <label style="display: flex; align-items: center; gap: 4px">
          <input
            type="checkbox"
            class="niveau-checkbox"
            value="Lycée"
            checked
            style="accent-color: #e84e9b; width: 18px; height: 18px"
          />
          Lycée
        </label>
        <label style="display: flex; align-items: center; gap: 4px">
          <input
            type="checkbox"
            class="niveau-checkbox"
            value="Collège"
            checked
            style="accent-color: #89d6e2; width: 18px; height: 18px"
          />
          Collège
        </label>
        <label style="display: flex; align-items: center; gap: 4px">
          <input
            type="checkbox"
            class="niveau-checkbox"
            value="Enseignants"
            checked
            style="accent-color: #fce86e; width: 18px; height: 18px"
          />
          Enseignants
        </label>
      </div>
      <div style="display: flex; align-items: center; gap: 18px">
        <span style="font-weight: bold; margin-right: 10px">Contenu :</span>
        <label style="display: flex; align-items: center; gap: 4px">
          <input
            type="checkbox"
            class="contenu-checkbox"
            value="Méthodologie"
            checked
            style="accent-color: #e84e9b; width: 18px; height: 18px"
          />
          Méthodologie
        </label>
        <label style="display: flex; align-items: center; gap: 4px">
          <input
            type="checkbox"
            class="contenu-checkbox"
            value="Pédagogie"
            checked
            style="accent-color: #89d6e2; width: 18px; height: 18px"
          />
          Pédagogie
        </label>
        <label style="display: flex; align-items: center; gap: 4px">
          <input
            type="checkbox"
            class="contenu-checkbox"
            value="Cours"
            checked
            style="accent-color: #fce86e; width: 18px; height: 18px"
          />
          Cours
        </label>
      </div>
    </div>

    <main>
      <table id="videoTable">
        <thead>
          <tr>
            <th>Vidéo</th>
            <th>Niveau</th>
            <th>Contenu</th>
            <th>Ressources (voir commentaires des vidéos)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <div class="form-container" id="add-video-form" style="display: none">
        <input
          type="text"
          id="videoUrl"
          placeholder="URL de la vidéo YouTube"
        />
        <input type="text" id="niveau" placeholder="Niveau" />
        <input type="text" id="contenu" placeholder="Contenu" />
        <input type="text" id="ressources" placeholder="Ressources" />
        <button onclick="addVideo()">Ajouter la vidéo</button>
      </div>
    </main>

    <script>
      const tbody = document.getElementById("tableBody");

      function getYouTubeId(url) {
        try {
          const parsed = new URL(url);
          if (parsed.hostname === "youtu.be") return parsed.pathname.slice(1);
          if (parsed.hostname.includes("youtube.com")) {
            // Gérer les YouTube Shorts
            if (parsed.pathname.startsWith("/shorts/")) {
              return parsed.pathname.split("/shorts/")[1];
            }
            // Gérer les URLs YouTube classiques
            return parsed.searchParams.get("v");
          }
        } catch {
          return null;
        }
        return null;
      }

      function insertRow(videoUrl, niveau, contenu, ressources) {
        const id = getYouTubeId(videoUrl) || "";
        const row = document.createElement("tr");

        const tdVideo = document.createElement("td");
        tdVideo.innerHTML = `
    <a href="${videoUrl}" target="_blank">
      <img class="thumb" src="https://img.youtube.com/vi/${id}/mqdefault.jpg" alt="Miniature vidéo">
    </a>
    <span class="edit-icon" style="cursor:pointer;display:block;margin-top:5px;color:#999;font-size:12px;" onclick="changeVideoUrl(this)">✏️ Modifier</span>
  `;

        // Désactiver l'édition de l'URL si pas connecté
        const editIcon = tdVideo.querySelector(".edit-icon");
        if (editIcon) {
          editIcon.style.pointerEvents = "none";
          editIcon.style.opacity = "0.3";
        }

        const tdNiveau = document.createElement("td");
        tdNiveau.innerHTML = niveau;
        tdNiveau.contentEditable = true;

        const tdContenu = document.createElement("td");
        tdContenu.innerHTML = contenu;
        tdContenu.contentEditable = true;

        const tdRessources = document.createElement("td");
        if (
          ressources &&
          ressources.startsWith &&
          ressources.startsWith('<div class="resource-container"')
        ) {
          // Si ressources est du HTML déjà généré, l'injecter directement
          tdRessources.innerHTML = ressources;
        } else {
          // Sinon, comportement normal (création DOM)
          const resourceContainer = document.createElement("div");
          resourceContainer.className = "resource-container";

          const resourceTitleWrapper = document.createElement("div");
          resourceTitleWrapper.className = "resource-title-wrapper";
          resourceTitleWrapper.style.position = "relative"; // Permet de positionner la coche par rapport au titre

          const resourceTitle = document.createElement("div");
          resourceTitle.className = "resource-title";
          resourceTitle.contentEditable = true;
          resourceTitle.textContent = "Titre";
          resourceTitle.addEventListener("focusout", saveTable);

          // Bouton pour supprimer le titre principal
          const deleteTitleBtn = document.createElement("button");
          deleteTitleBtn.textContent = "❌";
          deleteTitleBtn.className = "delete-btn";
          deleteTitleBtn.style.position = "absolute";
          deleteTitleBtn.style.top = "50%";
          deleteTitleBtn.style.right = "0px"; // Rapproche la coche à droite du titre
          deleteTitleBtn.style.transform = "translateY(-50%)"; // Centre verticalement la coche
          deleteTitleBtn.style.display = "none"; // Caché par défaut
          deleteTitleBtn.onclick = () => {
            resourceTitleWrapper.remove(); // Supprime complètement le conteneur du titre
            saveTable();
          };

          let hideTimeout;

          resourceTitleWrapper.addEventListener("mouseover", () => {
            clearTimeout(hideTimeout); // Annule le délai si la souris revient sur le titre
            deleteTitleBtn.style.display = "flex";
          });

          resourceTitleWrapper.addEventListener("mouseout", () => {
            hideTimeout = setTimeout(() => {
              deleteTitleBtn.style.display = "none";
            }, 300); // Délai de 300ms avant de cacher la coche
          });

          // Empêche la coche de disparaître lorsqu'elle est survolée
          deleteTitleBtn.addEventListener("mouseover", () => {
            clearTimeout(hideTimeout); // Annule le délai si la souris survole la coche
            deleteTitleBtn.style.display = "flex";
          });

          deleteTitleBtn.addEventListener("mouseout", () => {
            hideTimeout = setTimeout(() => {
              deleteTitleBtn.style.display = "none";
            }, 300); // Délai de 300ms avant de cacher la coche
          });

          // Afficher la coche uniquement au survol du titre ou de la coche elle-même
          resourceTitleWrapper.addEventListener("mouseover", () => {
            deleteTitleBtn.style.display = "flex";
          });
          resourceTitleWrapper.addEventListener("mouseout", () => {
            deleteTitleBtn.style.display = "none";
          });

          resourceTitleWrapper.appendChild(resourceTitle);
          resourceTitleWrapper.appendChild(deleteTitleBtn);

          const dropZone = document.createElement("div");
          dropZone.className = "drop-zone";
          dropZone.textContent = ""; // Zone vide mais fonctionnelle

          resourceContainer.appendChild(resourceTitleWrapper);
          resourceContainer.appendChild(dropZone);
          tdRessources.appendChild(resourceContainer);
        }
        row.append(tdVideo, tdNiveau, tdContenu, tdRessources);
        tbody.appendChild(row);

        // Appliquer les restrictions d'édition après l'ajout de la ligne
        disableEditing();

        // Drag & Drop
        tdRessources.addEventListener("dragover", (e) => {
          e.preventDefault();
          tdRessources.style.backgroundColor = "#ffe9f3";
        });

        tdRessources.addEventListener("dragleave", (e) => {
          e.preventDefault();
          tdRessources.style.backgroundColor = "#fafafa";
        });

        tdRessources.addEventListener("drop", (e) => {
          e.preventDefault();
          tdRessources.style.backgroundColor = "#fafafa";
          const files = e.dataTransfer.files;
          if (!files.length) return;

          Array.from(files).forEach((file) => {
            if (!file.type.startsWith("image/")) return;
            if (file.size > 2 * 1024 * 1024) {
              alert("Image trop lourde (> 2 Mo)");
              return;
            }

            const reader = new FileReader();
            reader.onload = () => {
              const block = document.createElement("div");
              block.className = "resource-block";

              const delBtn = document.createElement("button");
              delBtn.className = "delete-btn";
              delBtn.textContent = "❌";
              delBtn.onclick = () => {
                block.remove();
                saveTable();
              };

              const img = document.createElement("img");
              img.src = reader.result;
              img.className = "resource-img";

              const caption = document.createElement("div");
              caption.className = "image-title";
              caption.contentEditable = true;
              caption.textContent = "Titre de l'image";
              caption.addEventListener("focusout", saveTable);

              block.appendChild(delBtn);
              block.appendChild(img);
              block.appendChild(caption);

              // Toujours cibler le bon resource-container et drop-zone
              const resourceContainer = tdRessources.querySelector(
                ".resource-container"
              );
              let dropZone = resourceContainer.querySelector(".drop-zone");
              // Si le drop-zone n'est pas le dernier enfant, on le replace
              if (dropZone && resourceContainer.lastElementChild !== dropZone) {
                resourceContainer.appendChild(dropZone);
              }
              if (resourceContainer && dropZone) {
                resourceContainer.insertBefore(block, dropZone);
              }

              saveTable();
              // Réappliquer les restrictions après ajout d'image
              disableEditing();
            };
            reader.readAsDataURL(file); // Convertit automatiquement en Base64
          });
        });
      }

      function changeVideoUrl(el) {
        const td = el.closest("td");
        const oldUrl = td.querySelector("a").href;
        const newUrl = prompt("Nouvelle URL YouTube :", oldUrl);
        if (newUrl && getYouTubeId(newUrl)) {
          const newId = getYouTubeId(newUrl);
          td.innerHTML = `
      <a href="${newUrl}" target="_blank">
        <img class="thumb" src="https://img.youtube.com/vi/${newId}/mqdefault.jpg" alt="Miniature vidéo">
      </a>
      <span class="edit-icon" style="cursor:pointer;display:block;margin-top:5px;color:#999;font-size:12px;" onclick="changeVideoUrl(this)">✏️ Modifier</span>
    `;
          saveTable();
        } else {
          alert("URL YouTube invalide");
        }
      }

      function addVideo() {
        const url = document.getElementById("videoUrl").value.trim();
        const niveau = document.getElementById("niveau").value.trim();
        const contenu = document.getElementById("contenu").value.trim();
        const ressources = document.getElementById("ressources").value.trim();

        if (!getYouTubeId(url)) {
          alert("URL YouTube invalide");
          return;
        }

        insertRow(url, niveau, contenu, ressources);
        saveTable();

        document.getElementById("videoUrl").value = "";
        document.getElementById("niveau").value = "";
        document.getElementById("contenu").value = "";
        document.getElementById("ressources").value = "";
      }

      tbody.addEventListener("focusout", saveTable);

      // Fonction pour désactiver l'édition sans masquer l'interface
      function disableEditing() {
        // Désactiver l'édition des cellules
        const editableCells = document.querySelectorAll("td[contenteditable]");
        editableCells.forEach((cell) => {
          cell.contentEditable = "false";
          cell.style.backgroundColor = "#f9f9f9";
          cell.style.cursor = "not-allowed";
        });

        // Désactiver les boutons de suppression
        const deleteButtons = document.querySelectorAll(".delete-btn");
        deleteButtons.forEach((btn) => {
          btn.style.pointerEvents = "none";
          btn.style.opacity = "0.3";
        });

        // Désactiver le drag & drop
        const resourceContainers = document.querySelectorAll(
          ".resource-container"
        );
        resourceContainers.forEach((container) => {
          container.style.pointerEvents = "none";
        });

        // Désactiver les icônes d'édition d'URL
        const editIcons = document.querySelectorAll(".edit-icon");
        editIcons.forEach((icon) => {
          icon.style.pointerEvents = "none";
          icon.style.opacity = "0.3";
          icon.style.display = "none";
        });

        // Désactiver le tri des lignes
        const tableBody = document.getElementById("tableBody");
        if (tableBody) {
          const sortableInstance = Sortable.get(tableBody);
          if (sortableInstance) {
            sortableInstance.destroy();
          }
        }

        // Masquer le bouton sauvegarder et le formulaire d'ajout
        const saveBtn = document.getElementById("saveBtn");
        const addVideoForm = document.getElementById("add-video-form");

        if (saveBtn) {
          saveBtn.style.display = "none";
        }
        if (addVideoForm) {
          addVideoForm.style.display = "none";
        }
      }

      // Fonction pour activer l'édition
      function enableEditing() {
        // Activer l'édition des cellules
        const editableCells = document.querySelectorAll("td[contenteditable]");
        editableCells.forEach((cell) => {
          cell.contentEditable = "true";
          cell.style.backgroundColor = "";
          cell.style.cursor = "";
        });

        // Activer les boutons de suppression
        const deleteButtons = document.querySelectorAll(".delete-btn");
        deleteButtons.forEach((btn) => {
          btn.style.pointerEvents = "auto";
          btn.style.opacity = "1";
        });

        // Activer le drag & drop
        const resourceContainers = document.querySelectorAll(
          ".resource-container"
        );
        resourceContainers.forEach((container) => {
          container.style.pointerEvents = "auto";
        });

        // Activer les icônes d'édition d'URL
        const editIcons = document.querySelectorAll(".edit-icon");
        editIcons.forEach((icon) => {
          icon.style.pointerEvents = "auto";
          icon.style.opacity = "1";
          icon.style.display = "block";
        });

        // Réactiver le tri des lignes
        const tableBody = document.getElementById("tableBody");
        if (tableBody) {
          new Sortable(tableBody, {
            animation: 150,
            handle: "td",
            onEnd: function () {
              saveTable();
            },
          });
        }

        // Afficher le bouton sauvegarder et le formulaire d'ajout
        const saveBtn = document.getElementById("saveBtn");
        const addVideoForm = document.getElementById("add-video-form");

        if (saveBtn) {
          saveBtn.style.display = "inline-block";
        }
        if (addVideoForm) {
          addVideoForm.style.display = "block";
        }
      }

      // Désactiver l'édition par défaut après le chargement complet
      document.addEventListener("DOMContentLoaded", function () {
        loadTable();
        // Le tri sera activé seulement après connexion
        setTimeout(() => {
          disableEditing();
        }, 100);
      });

      // Fonction de chiffrement simple
      function encrypt(text) {
        return btoa(text.split("").reverse().join(""));
      }

      function decrypt(encrypted) {
        return atob(encrypted).split("").reverse().join("");
      }

      document.getElementById("connectBtn").onclick = async function () {
        const userId = prompt("Veuillez entrer votre identifiant :");
        if (userId && userId.trim()) {
          // Vérifier que l'identifiant est autorisé (double chiffrement)
          const expectedId = encrypt("michawaro4480");
          if (encrypt(userId.trim()) === expectedId) {
            // Demander le mot de passe
            const password = prompt("Veuillez entrer votre mot de passe :");
            const expectedPassword = encrypt("4480Svt4426");
            if (password && encrypt(password.trim()) === expectedPassword) {
              document.getElementById("userId").value = userId.trim();
              await loadFromSupabase();
              enableEditing();
            } else {
              alert("Mot de passe incorrect. Accès refusé.");
              document.getElementById("userId").value = "";
              disableEditing();
            }
          } else {
            alert(
              "Identifiant non autorisé. Seul l'administrateur peut accéder à cette page."
            );
            document.getElementById("userId").value = "";
            disableEditing();
          }
        }
      };

      document.getElementById("saveBtn").onclick = async function () {
        await saveToSupabase();
      };
    </script>
    <!-- --- FILTRE NIVEAU + CONTENU --- -->
    <script>
      function filtrerParNiveauEtContenu() {
        // Niveaux
        const checkboxesNiveau = document.querySelectorAll(".niveau-checkbox");
        const niveauxAffiches = Array.from(checkboxesNiveau)
          .filter((cb) => cb.checked)
          .map((cb) => cb.value);
        // Contenus
        const checkboxesContenu =
          document.querySelectorAll(".contenu-checkbox");
        const contenusAffiches = Array.from(checkboxesContenu)
          .filter((cb) => cb.checked)
          .map((cb) => cb.value.toUpperCase());
        // Pour chaque ligne du tableau
        document.querySelectorAll("#tableBody tr").forEach((row) => {
          const niveauCell = row.cells[1];
          const contenuCell = row.cells[2];
          if (!niveauCell || !contenuCell) return;
          const niveauTexte = niveauCell.textContent || "";
          const contenuTexte = (contenuCell.textContent || "").toUpperCase();
          // Filtrage Niveau
          const visibleNiveau = niveauxAffiches.some((niv) =>
            niveauTexte.includes(niv)
          );
          // Filtrage Contenu
          let visibleContenu = true;
          if (contenusAffiches.length < 3) {
            // Si une coche est décochée, on filtre
            if (
              !contenusAffiches.includes("MÉTHODOLOGIE") &&
              contenuTexte.includes("MÉTHODOLOGIE")
            )
              visibleContenu = false;
            if (
              !contenusAffiches.includes("PÉDAGOGIE") &&
              contenuTexte.includes("PÉDAGOGIE")
            )
              visibleContenu = false;
            if (
              !contenusAffiches.includes("COURS") &&
              contenuTexte.includes("COURS")
            )
              visibleContenu = false;
          }
          row.style.display = visibleNiveau && visibleContenu ? "" : "none";
        });
      }
      document
        .querySelectorAll(".niveau-checkbox, .contenu-checkbox")
        .forEach((cb) => {
          cb.addEventListener("change", filtrerParNiveauEtContenu);
        });
      document.addEventListener("DOMContentLoaded", filtrerParNiveauEtContenu);
    </script>
  </body>
</html>
