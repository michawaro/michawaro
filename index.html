<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Michawaro ‚Äì Apprendre, Enseigner, Partager</title>
    <meta
      name="description"
      content="Michawaro : plateforme √©ducative avec vid√©os YouTube, ressources p√©dagogiques et contenus organis√©s par niveau. Apprendre, enseigner et partager des connaissances."
    />
    <meta
      name="keywords"
      content="√©ducation, vid√©os √©ducatives, ressources p√©dagogiques, apprentissage, enseignement, YouTube √©ducatif"
    />
    <meta name="author" content="Michawaro" />
    <meta name="robots" content="index, follow" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://michawaro.github.io/michawaro/" />
    <meta
      property="og:title"
      content="Michawaro ‚Äì Apprendre, Enseigner, Partager"
    />
    <meta
      property="og:description"
      content="Plateforme √©ducative avec vid√©os YouTube et ressources p√©dagogiques organis√©es par niveau."
    />
    <meta
      property="og:image"
      content="https://michawaro.github.io/michawaro/og-image.jpg"
    />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta
      property="twitter:url"
      content="https://michawaro.github.io/michawaro/"
    />
    <meta
      property="twitter:title"
      content="Michawaro ‚Äì Apprendre, Enseigner, Partager"
    />
    <meta
      property="twitter:description"
      content="Plateforme √©ducative avec vid√©os YouTube et ressources p√©dagogiques organis√©es par niveau."
    />
    <meta
      property="twitter:image"
      content="https://michawaro.github.io/michawaro/og-image.jpg"
    />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "EducationalOrganization",
        "name": "Michawaro",
        "description": "Plateforme √©ducative avec vid√©os YouTube et ressources p√©dagogiques organis√©es par niveau",
        "url": "https://michawaro.github.io/michawaro/",
        "logo": "https://michawaro.github.io/michawaro/logo.png",
        "sameAs": [],
        "educationalCredentialAwarded": "Ressources p√©dagogiques",
        "hasOfferCatalog": {
          "@type": "OfferCatalog",
          "name": "Catalogue de ressources √©ducatives",
          "itemListElement": []
        }
      }
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        font-family: "Fredoka", sans-serif;
        background-color: #f5f5f5;
        color: #333;
      }

      header {
        background: linear-gradient(135deg, #e84e9b 40%, #89d6e2 100%);
        color: white;
        padding: 30px 10px;
        text-align: center;
      }

      header h1 {
        font-size: 2.8em;
        margin: 0;
        letter-spacing: 2px;
      }

      header p {
        font-size: 1.2em;
        margin-top: 10px;
        color: #fce86e;
      }

      main {
        padding: 30px 5vw;
      }

      table {
        width: 90vw;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        table-layout: fixed;
        border: 2px solid #bdbdbd;
      }

      th,
      td {
        padding: 7px 6px;
        border-bottom: 2px solid #bdbdbd;
        border-right: 2px solid #bdbdbd;
        text-align: center;
        vertical-align: middle;
        overflow-wrap: break-word;
        resize: horizontal;
        overflow: auto;
        position: relative;
      }

      th:last-child,
      td:last-child {
        border-right: none;
      }

      tr:last-child td {
        border-bottom: none;
      }

      th {
        background-color: #89d6e2;
        color: white;
        user-select: none;
      }

      td[contenteditable="true"] {
        background-color: #fffdf5;
        white-space: pre-wrap;
      }

      tr:hover {
        background-color: #f0f8f0 !important;
      }

      tr:hover td {
        background-color: #f0f8f0 !important;
      }

      .resource-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-end;
        gap: 8px;
        padding: 0;
        margin: 0;
        background: #fafafa;
        border-radius: 6px;
      }

      .resource-block {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        position: relative;
        max-width: 140px;
        background: #fff;
        padding: 0;
        border: 1px solid #ccc;
        border-radius: 6px;
        transition: box-shadow 0.3s;
        flex-grow: 1;
        margin: 0;
        max-height: 110px;
        height: 110px;
        overflow: hidden;
      }

      .resource-img {
        max-width: 100%;
        max-height: 110px;
        height: auto;
        object-fit: contain;
        border-radius: 4px;
        margin: 0;
        padding: 0;
        display: block;
      }

      /* R√©duction de 30% de la taille des vignettes YouTube */
      .thumb {
        width: 84%;
        height: auto;
        border-radius: 6px;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }

      .delete-btn {
        position: absolute;
        top: 3px; /* Ajustement pour centrer verticalement */
        right: 3px; /* Ajustement pour centrer horizontalement */
        background: rgba(255, 255, 255, 0.9); /* Blanc avec opacit√© r√©duite */
        color: red; /* Couleur de la croix */
        border: none;
        border-radius: 50%;
        width: 16px; /* Taille r√©duite */
        height: 16px;
        font-size: 10px; /* Taille de la croix */
        font-weight: bold; /* Rendre la croix plus visible */
        display: flex; /* Utilisation de flexbox */
        align-items: center; /* Centrer verticalement */
        justify-content: center; /* Centrer horizontalement */
        cursor: pointer;
        display: none; /* Cach√© par d√©faut */
        transition: background-color 0.3s, transform 0.2s;
      }

      .delete-btn:hover {
        background: rgba(255, 255, 255, 1); /* Blanc vif au survol */
        color: darkred; /* Couleur de la croix au survol */
        transform: scale(1.1); /* L√©g√®re mise en avant au survol */
      }

      .resource-block:hover .delete-btn {
        display: flex; /* Affich√© uniquement au survol de la ressource */
      }

      .resource-block {
        position: relative;
        flex-direction: column;
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 140px;
        background: #fff;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 6px;
        transition: box-shadow 0.3s;
      }

      .resource-block:hover {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* Effet visuel au survol */
      }

      .image-title {
        margin: 0;
        padding: 0;
        font-size: 0.85em;
        text-align: center;
        outline: none;
        width: 100%;
        color: black;
        white-space: pre-line; /* Permet les retours √† la ligne */
        overflow: visible;
        text-overflow: unset;
        max-height: none;
        min-height: 1.5em;
        word-break: break-word;
      }

      .resource-title {
        font-size: 0.9em;
        font-weight: bold;
        width: 100%;
        text-align: center;
        outline: none;
        color: black;
        margin: 0;
        padding: 0;
        white-space: pre-line; /* Permet les retours √† la ligne */
        overflow: visible; /* Laisse le texte s'afficher sans scroll */
        text-overflow: unset; /* Plus d'ellipse */
        max-height: none; /* Pas de limite de hauteur */
        min-height: 1.5em;
        word-break: break-word;
      }

      /* Styles pour les liens dans les titres */
      .resource-title a,
      .image-title a {
        color: #0066cc;
        text-decoration: underline;
        cursor: pointer;
      }

      .resource-title a:hover,
      .image-title a:hover {
        color: #0052a3;
        text-decoration: underline;
      }

      .resource-title-wrapper {
        width: 100%;
        text-align: center;
        margin: 0;
        padding: 0;
        position: relative;
      }

      .drop-zone {
        font-size: 0.85em;
        color: #999;
        width: 100%;
        text-align: center;
        margin: 0;
        padding: 0;
        min-height: 0;
      }

      .form-container {
        margin-top: 30px;
        background: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      }

      .form-container input {
        padding: 10px;
        margin-right: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        width: 18%;
      }

      .form-container button {
        padding: 10px 20px;
        border: none;
        background-color: #e84e9b;
        color: white;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
      }

      .form-container button:hover {
        background-color: #d13b88;
      }

      @media (max-width: 768px) {
        td,
        th {
          font-size: 0.9em;
          padding: 8px;
        }

        .form-container input {
          width: 100%;
          margin-bottom: 10px;
        }
        .resource-title,
        .image-title {
          font-size: 1em;
          white-space: pre-line;
          overflow: visible;
          text-overflow: unset;
          max-height: none;
          min-height: 1.5em;
          word-break: break-word;
        }
        .resource-block,
        .resource-title-wrapper {
          max-width: 100vw;
          width: 100%;
        }
      }
      .edit-icon {
        cursor: pointer;
        display: none;
        margin-top: 5px;
        color: #999;
        font-size: 12px;
      }
      td:nth-child(3) {
        white-space: pre-line;
      }
      body,
      html {
        overflow-x: hidden;
      }
      /* Cartouches harmonis√©s */
      .cartouche {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        padding: 0 0 10px 0; /* plus de padding-top */
        min-width: 270px;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: fit-content;
        height: 100%;
      }
      .cartouche-header {
        width: 100%;
        background: linear-gradient(90deg, #fce86e 0%, #e84e9b 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        text-align: center;
        font-weight: bold;
        font-size: 1.15em;
        letter-spacing: 2px;
        padding: 12px 0;
        margin-bottom: 12px;
        margin-top: 0;
      }
      .cartouche-content {
        width: 100%;
        padding: 0 18px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* Style pour le bouton de suppression de ligne */
      .delete-row-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        display: none;
        transition: background-color 0.3s, transform 0.2s;
        z-index: 10;
      }

      /* Styles pour les cases √† cocher de s√©lection */
      .row-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        display: none;
      }

      .admin-mode .row-checkbox {
        display: block;
      }

      th:nth-child(1),
      td:nth-child(1) {
        width: 50px;
        min-width: 50px;
        max-width: 50px;
        text-align: center;
      }

      th:nth-child(2),
      td:nth-child(2) {
        width: 270px;
        min-width: 237px;
        max-width: 304px;
        padding-left: 2px;
        padding-right: 2px;
      }

      th:nth-child(3),
      td:nth-child(3) {
        width: 135px;
        min-width: 105px;
        max-width: 180px;
        white-space: pre-line;
      }

      /* Bouton supprimer les s√©lectionn√©es */
      #deleteSelectedBtn {
        display: none;
      }

      .admin-mode #deleteSelectedBtn {
        display: inline-block;
      }

      .delete-row-btn:hover {
        background: rgba(255, 0, 0, 1);
        transform: scale(1.1);
      }

      /* Boutons de suppression de ligne - visibles seulement en mode admin */
      tr:hover .delete-row-btn {
        display: none;
      }

      .admin-mode tr:hover .delete-row-btn {
        display: block !important;
      }

      /* Alternative : afficher le bouton au survol de la cellule vid√©o */
      td:hover .delete-row-btn {
        display: none;
      }

      .admin-mode td:hover .delete-row-btn {
        display: block !important;
      }

      /* Styles pour les drapeaux */
      .flag-container {
        position: absolute;
        top: 5px;
        right: 5px;
        z-index: 5;
        pointer-events: auto; /* Permet de cliquer sur le conteneur */
      }

      .flag-container .flag {
        pointer-events: auto; /* Permet de cliquer sur le drapeau */
      }

      .flag-container button {
        pointer-events: auto; /* Permet de cliquer sur les boutons */
      }

      .flag {
        width: 24px;
        height: 16px;
        border-radius: 2px;
        cursor: pointer;
        transition: transform 0.2s;
        border: 1px solid #ccc;
      }

      .flag:hover {
        transform: scale(1.1);
      }

      .flag-english {
        background: linear-gradient(
          to bottom,
          #012169 0%,
          #012169 33%,
          #ffffff 33%,
          #ffffff 66%,
          #c8102e 66%,
          #c8102e 100%
        );
      }

      .flag-spanish {
        background: linear-gradient(
          to bottom,
          #c60b1e 0%,
          #c60b1e 25%,
          #ffc400 25%,
          #ffc400 75%,
          #c60b1e 75%,
          #c60b1e 100%
        );
      }

      .add-flag-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        display: none;
        z-index: 6;
      }

      .add-flag-btn:hover {
        background: rgba(0, 0, 0, 0.9);
      }

      /* Bouton d'ajout de drapeau - visible seulement en mode admin */
      .add-flag-btn {
        display: none;
      }

      /* Afficher le bouton seulement si l'utilisateur est connect√© */
      .admin-mode td:nth-child(3):hover .add-flag-btn {
        display: block !important;
      }

      .flag-menu {
        position: absolute;
        bottom: 30px;
        right: 5px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 10;
      }

      .flag-menu button {
        display: block;
        width: 100%;
        padding: 4px 8px;
        margin: 2px 0;
        border: none;
        background: #f5f5f5;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .flag-menu button:hover {
        background: #e0e0e0;
      }

      .flag-url-input {
        width: 100%;
        padding: 4px;
        margin-top: 4px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 11px;
      }
    </style>
  </head>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Ajout EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    const SUPABASE_URL = "https://nfqaijeeozypkvkrxfwh.supabase.co"; // Remplace par ton URL
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mcWFpamVlb3p5cGt2a3J4ZndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NDAzMDUsImV4cCI6MjA2ODQxNjMwNX0.6z0kRlR_qUSxP_jPngOfF1mcNbiMZBS3RsategLrjxo"; // Cl√© publique (anonyme) ‚Äî attention √† la config RLS

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function saveToSupabase() {
      const userIdElement = document.getElementById("userId");
      if (!userIdElement) {
        console.warn("√âl√©ment userId non trouv√©");
        return;
      }

      const userId = userIdElement.value.trim();

      // R√©cup√©rer toutes les lignes de la table
      const rows = [...tbody.querySelectorAll("tr")];

      // Pr√©parer les nouvelles donn√©es
      const videosData = rows.map((row, index) => {
        // La premi√®re colonne est maintenant la case √† cocher, donc la vid√©o est √† l'index 1
        const videoCell = row.cells[1];
        const videoLink = videoCell?.querySelector("a")?.href || "";

        // R√©cup√©rer les donn√©es des ressources et les convertir en JSON
        // Les ressources sont maintenant √† l'index 4 (apr√®s checkbox, vid√©o, niveau, contenu)
        const ressourcesCell = row.cells[4];
        const resourceContainer = ressourcesCell.querySelector(
          ".resource-container"
        );

        let ressourcesJSON = {
          titre: "",
          images: [],
        };

        if (resourceContainer) {
          // R√©cup√©rer le titre principal
          const titreElement =
            resourceContainer.querySelector(".resource-title");
          if (titreElement) {
            ressourcesJSON.titre = titreElement.innerHTML || "";
          }

          // R√©cup√©rer les images et leurs titres
          const imageBlocks =
            resourceContainer.querySelectorAll(".resource-block");
          imageBlocks.forEach((block) => {
            const img = block.querySelector("img");
            const caption = block.querySelector(".image-title");

            if (img && caption) {
              // V√©rifier si l'image est dans un lien
              const linkElement = img.closest("a");
              const imageLink = linkElement ? linkElement.href : null;

              ressourcesJSON.images.push({
                src: img.src, // Base64 de l'image
                titre: caption.innerHTML || "",
                link: imageLink || null, // URL du lien si l'image est cliquable
              });
            }
          });
        }

        return {
          user_id: userId,
          video_url: videoLink,
          niveau: row.cells[2].innerHTML, // Niveau est maintenant √† l'index 2
          contenu: row.cells[3].innerHTML, // Contenu est maintenant √† l'index 3
          ressources: ressourcesJSON, // Structure JSON
          ordre: index,
        };
      });

      // LOG pour diagnostic
      console.log(
        "Donn√©es √† sauvegarder :",
        JSON.stringify(videosData, null, 2)
      );

      // Sauvegarde incr√©mentale optimis√©e pour multi-supports
      if (videosData.length > 0) {
        let successCount = 0;
        let errorCount = 0;

        for (const videoData of videosData) {
          // LOG pour chaque vid√©o
          console.log("Vid√©o √† sauvegarder :", videoData);
          // V√©rifier si la vid√©o existe d√©j√† pour cet utilisateur
          const { data: existingData } = await supabaseClient
            .from("videos")
            .select("id")
            .eq("user_id", userId)
            .eq("video_url", videoData.video_url)
            .single();

          if (existingData) {
            // Mettre √† jour la vid√©o existante
            const { error: updateError } = await supabaseClient
              .from("videos")
              .update({
                niveau: videoData.niveau,
                contenu: videoData.contenu,
                ressources: videoData.ressources, // Structure JSON
                ordre: videoData.ordre,
              })
              .eq("id", existingData.id);

            if (updateError) {
              console.error(
                "Erreur lors de la mise √† jour:",
                updateError.message
              );
              errorCount++;
            } else {
              successCount++;
            }
          } else {
            // Ins√©rer une nouvelle vid√©o
            const { error: insertError } = await supabaseClient
              .from("videos")
              .insert(videoData);

            if (insertError) {
              console.error("Erreur lors de l'insertion:", insertError.message);
              errorCount++;
            } else {
              successCount++;
            }
          }
        }

        if (errorCount > 0) {
          console.warn(`${errorCount} erreurs lors de la sauvegarde`);
        }

        if (successCount > 0) {
          console.log(`${successCount} vid√©os sauvegard√©es avec succ√®s`);
        }
      }
    }

    async function loadFromSupabase() {
      const userIdElement = document.getElementById("userId");
      if (!userIdElement) {
        console.warn("√âl√©ment userId non trouv√©");
        return;
      }

      const userId = userIdElement.value.trim();

      // Charger les donn√©es publiques par d√©faut (userId vide) ou pour l'utilisateur sp√©cifique
      let query = supabaseClient
        .from("videos")
        .select("video_url, niveau, contenu, ressources, ordre")
        .order("ordre", { ascending: true, nullsFirst: true });

      // Si un userId est sp√©cifi√©, filtrer par utilisateur
      if (userId) {
        query = query.eq("user_id", userId);
      } else {
        // En mode public, charger les donn√©es publiques (par exemple userId = "public" ou vide)
        query = query.eq("user_id", "michawaro4480"); // Utiliser l'ID par d√©faut pour les donn√©es publiques
      }

      const { data, error } = await query;

      // LOG pour diagnostic
      console.log("Chargement avec userId:", userId);
      console.log("Donn√©es charg√©es depuis Supabase :", data);
      console.log("Nombre de lignes charg√©es :", data ? data.length : 0);

      if (error) {
        console.warn("Pas de donn√©es Supabase ou erreur :", error.message);
        return;
      }

      console.log(
        "Vidage du tableau et chargement de",
        data.length,
        "√©l√©ments"
      );
      tbody.innerHTML = "";
      data.forEach((item, index) => {
        console.log(`Chargement √©l√©ment ${index + 1}:`, item.video_url);
        // Convertir les ressources JSON en HTML
        let ressourcesHTML =
          '<div class="resource-container"><div class="resource-title-wrapper"><div class="resource-title" contenteditable="true">Titre</div></div><div class="drop-zone"></div></div>';

        if (item.ressources && typeof item.ressources === "object") {
          // Reconstruire le HTML √† partir des donn√©es JSON
          ressourcesHTML = '<div class="resource-container">';

          // Titre principal
          if (item.ressources.titre) {
            ressourcesHTML += `<div class="resource-title-wrapper"><div class="resource-title" contenteditable="true">${item.ressources.titre}</div></div>`;
          } else {
            ressourcesHTML +=
              '<div class="resource-title-wrapper"><div class="resource-title" contenteditable="true">Titre</div></div>';
          }

          // Images
          if (item.ressources.images && item.ressources.images.length > 0) {
            item.ressources.images.forEach((image) => {
              // Si l'image a un lien, l'envelopper dans un <a>
              const imgTag = `<img src="${image.src}" class="resource-img" alt="Ressource p√©dagogique" loading="lazy">`;
              const imgWithLink = image.link
                ? `<a href="${image.link}" target="_blank">${imgTag}</a>`
                : imgTag;

              ressourcesHTML += `
                <div class="resource-block">
                  <button class="delete-btn" onclick="this.parentElement.remove(); saveTable();">‚ùå</button>
                  ${imgWithLink}
                  <div class="image-title" contenteditable="true">${image.titre}</div>
                </div>
              `;
            });
          }

          ressourcesHTML += '<div class="drop-zone"></div></div>';
        }

        insertRow(item.video_url, item.niveau, item.contenu, ressourcesHTML);
        // Ajout des √©couteurs focusout sur les titres apr√®s l'injection HTML
        const lastRow = tbody.lastElementChild;
        if (lastRow) {
          const resourceTitle = lastRow.querySelector(".resource-title");
          if (resourceTitle) {
            resourceTitle.addEventListener("focusout", saveTable);
          }
          const imageTitles = lastRow.querySelectorAll(".image-title");
          imageTitles.forEach((caption) => {
            caption.addEventListener("focusout", saveTable);
          });

          // S'assurer que le bouton de suppression est bien configur√©
          const deleteRowBtn = lastRow.querySelector(".delete-row-btn");
          if (deleteRowBtn) {
            deleteRowBtn.onclick = () => confirmDeleteRow(lastRow);
          }
        }
      });

      // Ne pas appeler disableEditing() ici - c'est g√©r√© par loadTable()

      // Rendre tous les drapeaux existants cliquables
      setTimeout(() => {
        makeAllFlagsClickable();
        // Attacher les gestionnaires d'√©v√©nements aux cases √† cocher existantes
        attachCheckboxHandlers();
        // R√©initialiser la derni√®re case coch√©e
        lastCheckedCheckbox = null;
        // Mettre √† jour l'√©tat de la case "Tout s√©lectionner"
        updateSelectAllCheckbox();
      }, 200);
    }

    // Fonction pour attacher les gestionnaires d'√©v√©nements aux cases √† cocher
    function attachCheckboxHandlers() {
      const rowCheckboxes = document.querySelectorAll(
        ".row-checkbox:not(#selectAllCheckbox)"
      );
      rowCheckboxes.forEach((checkbox) => {
        // Supprimer l'ancien gestionnaire s'il existe
        checkbox.removeEventListener("click", handleCheckboxClick);
        // Ajouter le nouveau gestionnaire
        checkbox.addEventListener("click", handleCheckboxClick);
      });
    }

    // Fonction pour rendre tous les drapeaux cliquables
    function makeAllFlagsClickable() {
      const flags = document.querySelectorAll(".flag-container .flag");
      flags.forEach((flag) => {
        const url = flag.dataset.url;
        if (url && url.trim()) {
          // Supprimer l'ancien event listener s'il existe
          if (flag._clickHandler) {
            flag.removeEventListener("click", flag._clickHandler);
          }

          // Cr√©er et attacher le nouvel event listener
          flag._clickHandler = (e) => {
            e.stopPropagation();
            e.preventDefault();
            console.log("Clic sur drapeau charg√©, URL:", url);
            window.open(url, "_blank");
          };
          flag.addEventListener("click", flag._clickHandler);

          // S'assurer que le drapeau est cliquable
          flag.style.cursor = "pointer";
          flag.style.pointerEvents = "auto";
          flag.style.zIndex = "10";
        }
      });
    }

    // Remplace ou compl√®te la logique existante :
    async function saveTable() {
      await saveToSupabase();
    }
    let isLoading = false; // Flag pour √©viter les chargements multiples

    async function loadTable() {
      if (isLoading) {
        console.log("Chargement d√©j√† en cours, ignor√©");
        return;
      }

      isLoading = true;
      console.log("D√©but du chargement des donn√©es");

      try {
        await loadFromSupabase();
        console.log("Chargement termin√©");

        // Appliquer l'√©tat des boutons APR√àS le chargement des donn√©es
        const encryptedUserId = localStorage.getItem("adminUserId");
        if (encryptedUserId) {
          const userId = decrypt(encryptedUserId);
          document.getElementById("userId").value = userId;
          setTimeout(() => {
            enableEditing();
            makeAllFlagsClickable(); // Rendre les drapeaux cliquables
          }, 100);
        } else {
          setTimeout(() => {
            disableEditing();
            makeAllFlagsClickable(); // Rendre les drapeaux cliquables m√™me en mode public
          }, 100);
        }
      } finally {
        isLoading = false;
      }
    }

    // Fonction pour supprimer une ligne c√¥t√© Supabase
    async function deleteRowFromSupabase(videoUrl) {
      const userIdElement = document.getElementById("userId");
      let userId = "michawaro4480"; // Utiliser l'ID public par d√©faut

      if (userIdElement && userIdElement.value.trim()) {
        userId = userIdElement.value.trim();
      }

      console.log(
        "Suppression de la ligne avec userId:",
        userId,
        "videoUrl:",
        videoUrl
      );

      try {
        // Supprimer de TOUS les user_id possibles pour √©viter les incoh√©rences
        const { error: error1 } = await supabaseClient
          .from("videos")
          .delete()
          .eq("user_id", userId)
          .eq("video_url", videoUrl);

        // Aussi supprimer avec l'ID public au cas o√π
        const { error: error2 } = await supabaseClient
          .from("videos")
          .delete()
          .eq("user_id", "michawaro4480")
          .eq("video_url", videoUrl);

        if (error1 && error2) {
          console.error(
            "Erreur lors de la suppression:",
            error1.message || error2.message
          );
          return false;
        }

        console.log("Ligne supprim√©e avec succ√®s de Supabase");
        return true;
      } catch (err) {
        console.error("Erreur lors de la suppression:", err);
        return false;
      }
    }

    // Fonction de confirmation avant suppression
    function confirmDeleteRow(row) {
      // La premi√®re colonne est maintenant la case √† cocher, donc on prend la deuxi√®me colonne (index 1) pour la vid√©o
      const videoCell = row.cells[1];
      const videoUrl = videoCell?.querySelector("a")?.href || "";
      const videoTitle =
        videoCell?.querySelector("a img")?.alt || "cette vid√©o";

      const confirmed = confirm(
        `√ätes-vous s√ªr de vouloir supprimer d√©finitivement ${videoTitle} ?\n\nCette action supprimera la ligne du tableau ET de la base de donn√©es Supabase.\n\nCette action est irr√©versible !`
      );

      if (confirmed) {
        deleteRow(row, videoUrl);
      }
    }

    // Fonction principale de suppression
    async function deleteRow(row, videoUrl) {
      console.log(
        "Tentative de suppression de la ligne avec videoUrl:",
        videoUrl
      );

      // Supprimer c√¥t√© Supabase d'abord
      const supabaseSuccess = await deleteRowFromSupabase(videoUrl);

      if (supabaseSuccess) {
        // Supprimer c√¥t√© UI
        row.remove();
        console.log("Ligne supprim√©e avec succ√®s de l'UI et de Supabase");
        // Pas besoin de sauvegarder car la suppression est d√©j√† faite c√¥t√© Supabase
      } else {
        console.error("√âchec de la suppression c√¥t√© Supabase");
        alert(
          "Erreur lors de la suppression de la base de donn√©es. La ligne n'a pas √©t√© supprim√©e."
        );
      }
    }

    // Fonction pour supprimer toutes les lignes s√©lectionn√©es
    async function deleteSelectedRows() {
      const selectedCheckboxes = document.querySelectorAll(
        ".row-checkbox:checked:not(#selectAllCheckbox)"
      );

      if (selectedCheckboxes.length === 0) {
        alert("Aucune ligne s√©lectionn√©e.");
        return;
      }

      const count = selectedCheckboxes.length;
      const confirmed = confirm(
        `√ätes-vous s√ªr de vouloir supprimer d√©finitivement ${count} ligne${
          count > 1 ? "s" : ""
        } ?\n\nCette action supprimera les lignes du tableau ET de la base de donn√©es Supabase.\n\nCette action est irr√©versible !`
      );

      if (!confirmed) {
        return;
      }

      // R√©cup√©rer toutes les lignes s√©lectionn√©es avec leurs URLs
      const rowsToDelete = [];
      selectedCheckboxes.forEach((checkbox) => {
        const row = checkbox.closest("tr");
        // La premi√®re colonne est maintenant la case √† cocher, donc la vid√©o est √† l'index 1
        const videoCell = row.cells[1];
        const videoUrl =
          checkbox.dataset.videoUrl ||
          videoCell?.querySelector("a")?.href ||
          "";
        if (row && videoUrl) {
          rowsToDelete.push({ row, videoUrl });
        }
      });

      // Supprimer toutes les lignes
      let successCount = 0;
      let errorCount = 0;

      for (const { row, videoUrl } of rowsToDelete) {
        const success = await deleteRowFromSupabase(videoUrl);
        if (success) {
          row.remove();
          successCount++;
        } else {
          errorCount++;
        }
      }

      // R√©initialiser la case "Tout s√©lectionner" et la derni√®re case coch√©e
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
      }
      lastCheckedCheckbox = null;
      updateSelectAllCheckbox();

      // Afficher un message de r√©sultat
      if (errorCount > 0) {
        alert(
          `${successCount} ligne${successCount > 1 ? "s" : ""} supprim√©e${
            successCount > 1 ? "s" : ""
          } avec succ√®s.\n${errorCount} erreur${
            errorCount > 1 ? "s" : ""
          } lors de la suppression.`
        );
      } else {
        console.log(
          `${successCount} ligne${successCount > 1 ? "s" : ""} supprim√©e${
            successCount > 1 ? "s" : ""
          } avec succ√®s`
        );
      }
    }

    // Variable pour m√©moriser la derni√®re case coch√©e (pour la s√©lection par plage avec Shift)
    let lastCheckedCheckbox = null;

    // Fonction pour g√©rer la case "Tout s√©lectionner"
    function toggleSelectAll() {
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      const rowCheckboxes = document.querySelectorAll(
        ".row-checkbox:not(#selectAllCheckbox)"
      );

      if (selectAllCheckbox) {
        const isChecked = selectAllCheckbox.checked;
        rowCheckboxes.forEach((checkbox) => {
          checkbox.checked = isChecked;
        });
        // Mettre √† jour la derni√®re case coch√©e
        if (isChecked && rowCheckboxes.length > 0) {
          lastCheckedCheckbox = rowCheckboxes[rowCheckboxes.length - 1];
        } else {
          lastCheckedCheckbox = null;
        }
        updateSelectAllCheckbox();
      }
    }

    // Fonction pour mettre √† jour l'√©tat de la case "Tout s√©lectionner"
    function updateSelectAllCheckbox() {
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      const rowCheckboxes = document.querySelectorAll(
        ".row-checkbox:not(#selectAllCheckbox)"
      );

      if (selectAllCheckbox && rowCheckboxes.length > 0) {
        const allChecked = Array.from(rowCheckboxes).every((cb) => cb.checked);
        const someChecked = Array.from(rowCheckboxes).some((cb) => cb.checked);
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
      }
    }

    // Fonction pour g√©rer la s√©lection par plage avec Shift+clic
    function handleCheckboxClick(event) {
      const checkbox = event.target;

      // Ignorer si c'est la case "Tout s√©lectionner"
      if (checkbox.id === "selectAllCheckbox") {
        return;
      }

      // Si Shift est maintenu et qu'il y a une derni√®re case coch√©e
      if (event.shiftKey && lastCheckedCheckbox) {
        // Si on clique sur la m√™me case, ne rien faire
        if (lastCheckedCheckbox === checkbox) {
          return;
        }
        event.preventDefault(); // Emp√™cher le changement d'√©tat imm√©diat

        // R√©cup√©rer toutes les cases √† cocher
        const allCheckboxes = Array.from(
          document.querySelectorAll(".row-checkbox:not(#selectAllCheckbox)")
        );

        // Trouver les indices de la derni√®re case coch√©e et de la case actuelle
        const lastIndex = allCheckboxes.indexOf(lastCheckedCheckbox);
        const currentIndex = allCheckboxes.indexOf(checkbox);

        // Si les indices ne sont pas valides, sortir
        if (lastIndex === -1 || currentIndex === -1) {
          return;
        }

        // D√©terminer la plage √† s√©lectionner
        const startIndex = Math.min(lastIndex, currentIndex);
        const endIndex = Math.max(lastIndex, currentIndex);

        // L'√©tat cible est bas√© sur l'√©tat de la derni√®re case coch√©e
        const targetState = lastCheckedCheckbox.checked;

        // S√©lectionner toutes les cases dans la plage
        for (let i = startIndex; i <= endIndex; i++) {
          allCheckboxes[i].checked = targetState;
        }

        // Mettre √† jour la derni√®re case coch√©e √† la case actuelle
        lastCheckedCheckbox = checkbox;
      } else {
        // Si pas de Shift, mettre √† jour la derni√®re case coch√©e
        if (checkbox.checked) {
          lastCheckedCheckbox = checkbox;
        } else {
          // Si on d√©coche, garder la derni√®re case coch√©e pr√©c√©dente si elle existe
          const allCheckboxes = Array.from(
            document.querySelectorAll(".row-checkbox:not(#selectAllCheckbox)")
          );
          const currentIndex = allCheckboxes.indexOf(checkbox);
          // Chercher la derni√®re case coch√©e avant celle-ci
          for (let i = currentIndex - 1; i >= 0; i--) {
            if (allCheckboxes[i].checked) {
              lastCheckedCheckbox = allCheckboxes[i];
              break;
            }
          }
          // Si aucune case n'est coch√©e avant, chercher apr√®s
          if (!lastCheckedCheckbox || !lastCheckedCheckbox.checked) {
            for (let i = currentIndex + 1; i < allCheckboxes.length; i++) {
              if (allCheckboxes[i].checked) {
                lastCheckedCheckbox = allCheckboxes[i];
                break;
              }
            }
          }
          // Si aucune case n'est coch√©e, r√©initialiser
          if (!lastCheckedCheckbox || !lastCheckedCheckbox.checked) {
            lastCheckedCheckbox = null;
          }
        }
      }

      // Mettre √† jour la case "Tout s√©lectionner"
      updateSelectAllCheckbox();
    }

    // Fonctions pour g√©rer les drapeaux
    function showFlagMenu(button, cell) {
      console.log("showFlagMenu appel√©", button, cell);

      // Fermer tous les autres menus ouverts
      document.querySelectorAll(".flag-menu").forEach((menu) => menu.remove());

      const menu = document.createElement("div");
      menu.className = "flag-menu";
      menu.style.display = "block";
      menu.style.position = "absolute";
      menu.style.bottom = "30px";
      menu.style.right = "5px";
      menu.style.zIndex = "1000";

      // Cr√©er les boutons avec des fonctions inline plus simples
      const englishBtn = document.createElement("button");
      englishBtn.innerHTML =
        '<img src="https://flagcdn.com/16x12/gb.png" width="16" height="12" alt="English flag"> English';
      englishBtn.onclick = () => {
        const urlInput = menu.querySelector(".flag-url-input");
        const url = urlInput ? urlInput.value.trim() : "";
        addFlag("english", cell, url);
        menu.remove();
      };

      const spanishBtn = document.createElement("button");
      spanishBtn.innerHTML =
        '<img src="https://flagcdn.com/16x12/es.png" width="16" height="12" alt="Spanish flag"> Espa√±ol';
      spanishBtn.onclick = () => {
        const urlInput = menu.querySelector(".flag-url-input");
        const url = urlInput ? urlInput.value.trim() : "";
        addFlag("spanish", cell, url);
        menu.remove();
      };

      const urlInput = document.createElement("input");
      urlInput.type = "text";
      urlInput.className = "flag-url-input";
      urlInput.placeholder = "URL (optionnel)";

      menu.appendChild(englishBtn);
      menu.appendChild(spanishBtn);
      menu.appendChild(urlInput);

      cell.appendChild(menu);
      console.log("Menu cr√©√© et ajout√©:", menu);

      // Fermer le menu si on clique ailleurs
      setTimeout(() => {
        document.addEventListener("click", function closeMenu(e) {
          if (!menu.contains(e.target) && e.target !== button) {
            menu.remove();
            document.removeEventListener("click", closeMenu);
          }
        });
      }, 100);
    }

    function addFlag(type, cell, url) {
      console.log("addFlag appel√©", type, cell, url);

      // Supprimer le bouton d'ajout de drapeau
      const addBtn = cell.querySelector(".add-flag-btn");
      if (addBtn) {
        addBtn.remove();
      }

      // Cr√©er le conteneur de drapeau
      const flagContainer = document.createElement("div");
      flagContainer.className = "flag-container";

      const flag = document.createElement("img");
      flag.className = "flag";
      flag.src =
        type === "english"
          ? "https://flagcdn.com/16x12/gb.png"
          : "https://flagcdn.com/16x12/es.png";
      flag.alt = type === "english" ? "English flag" : "Spanish flag";
      flag.title = type === "english" ? "Anglais" : "Espagnol";
      flag.style.width = "24px";
      flag.style.height = "16px";
      flag.style.borderRadius = "2px";
      flag.style.cursor = "pointer";
      flag.style.transition = "transform 0.2s";
      flag.style.border = "1px solid #ccc";

      // Ajouter un bouton pour √©diter l'URL (visible seulement en mode admin)
      const editUrlBtn = document.createElement("button");
      editUrlBtn.innerHTML = "‚úèÔ∏è";
      editUrlBtn.style.cssText = `
        position: absolute;
        top: -8px;
        right: -8px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        font-size: 10px;
        cursor: pointer;
        display: none;
        z-index: 7;
      `;
      editUrlBtn.title = "Modifier l'URL";
      editUrlBtn.onclick = (e) => {
        e.stopPropagation();
        editFlagUrl(flagContainer, type);
      };

      // Ajouter un bouton pour supprimer le drapeau (visible seulement en mode admin)
      const deleteFlagBtn = document.createElement("button");
      deleteFlagBtn.innerHTML = "‚ùå";
      deleteFlagBtn.style.cssText = `
        position: absolute;
        top: -8px;
        left: -8px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        font-size: 10px;
        cursor: pointer;
        display: none;
        z-index: 7;
      `;
      deleteFlagBtn.title = "Supprimer le drapeau";
      deleteFlagBtn.onclick = (e) => {
        e.stopPropagation();
        flagContainer.remove();
        saveTable();
      };

      // Si une URL est fournie, rendre le drapeau cliquable
      if (url) {
        flag.style.cursor = "pointer";
        flag.style.pointerEvents = "auto"; // S'assurer que les clics fonctionnent
        flag.style.zIndex = "10"; // S'assurer que le drapeau est au-dessus
        flag.title += ` - ${url}`;
        flag.dataset.url = url; // Stocker l'URL dans le dataset

        // Attacher l'√©v√©nement click avec addEventListener pour plus de fiabilit√©
        flag.addEventListener("click", (e) => {
          e.stopPropagation();
          e.preventDefault();
          console.log("Clic sur drapeau, URL:", url);
          window.open(url, "_blank");
        });
      }

      flagContainer.appendChild(flag);
      flagContainer.appendChild(editUrlBtn);
      flagContainer.appendChild(deleteFlagBtn);
      cell.appendChild(flagContainer);

      // Remettre le focus sur la cellule pour que le curseur soit au bon endroit
      setTimeout(() => {
        cell.focus();
        // Placer le curseur au d√©but du contenu
        const range = document.createRange();
        const sel = window.getSelection();
        range.setStart(cell.firstChild, 0);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }, 100);

      // Ajouter l'effet de survol pour l'image
      flag.addEventListener("mouseenter", () => {
        flag.style.transform = "scale(1.1)";
      });
      flag.addEventListener("mouseleave", () => {
        flag.style.transform = "scale(1)";
      });

      // Afficher les boutons d'√©dition et suppression au survol (mode admin seulement)
      const encryptedUserId = localStorage.getItem("adminUserId");
      if (encryptedUserId) {
        flagContainer.addEventListener("mouseenter", () => {
          editUrlBtn.style.display = "block";
          deleteFlagBtn.style.display = "block";
        });
        flagContainer.addEventListener("mouseleave", () => {
          editUrlBtn.style.display = "none";
          deleteFlagBtn.style.display = "none";
        });
      }

      console.log("Drapeau ajout√©:", flag);

      // Sauvegarder les changements
      saveTable();
    }

    function editFlagUrl(flagContainer, type) {
      const flag = flagContainer.querySelector(".flag");
      const currentUrl = flag.dataset.url || "";

      const newUrl = prompt("Modifier l'URL du drapeau:", currentUrl);
      if (newUrl !== null) {
        if (newUrl.trim()) {
          flag.style.cursor = "pointer";
          flag.style.pointerEvents = "auto";
          flag.style.zIndex = "10";

          // Supprimer l'ancien event listener s'il existe
          flag.removeEventListener("click", flag._clickHandler);

          // Cr√©er et attacher le nouvel event listener
          flag._clickHandler = (e) => {
            e.stopPropagation();
            e.preventDefault();
            console.log("Clic sur drapeau modifi√©, URL:", newUrl.trim());
            window.open(newUrl.trim(), "_blank");
          };
          flag.addEventListener("click", flag._clickHandler);

          flag.title = `${
            type === "english" ? "Anglais" : "Espagnol"
          } - ${newUrl.trim()}`;
          flag.dataset.url = newUrl.trim();
        } else {
          flag.style.cursor = "default";
          flag.style.pointerEvents = "auto";
          flag.style.zIndex = "10";

          // Supprimer l'event listener
          flag.removeEventListener("click", flag._clickHandler);
          flag._clickHandler = null;

          flag.title = type === "english" ? "Anglais" : "Espagnol";
          flag.dataset.url = "";
        }
        saveTable();
      }
    }
  </script>

  <body>
    <header role="banner">
      <h1>MICHAWARO</h1>
      <p>Apprendre, Enseigner, Partager</p>
    </header>

    <!-- √Ä placer juste avant la balise <main> ou juste apr√®s <header> -->

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
        margin: 10px 5vw 0 0;
      "
    >
      <input
        type="text"
        id="userId"
        value="michawaro4480"
        placeholder="Identifiant"
        style="
          padding: 6px 10px;
          border-radius: 6px;
          border: 1px solid #ccc;
          font-family: inherit;
          font-size: 1em;
          width: 160px;
          display: none;
        "
      />
      <button
        id="connectBtn"
        aria-label="Se connecter en tant qu'administrateur"
        style="
          background: #89d6e2;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 7px 16px;
          font-weight: bold;
          cursor: pointer;
          font-family: inherit;
          font-size: 1em;
        "
      >
        Connexion
      </button>
      <div style="display: flex; align-items: center; gap: 10px">
        <p
          style="text-align: center; font-size: 0.75em; color: #666; margin: 0"
        >
          üîí R√©serv√© √† l'admin
        </p>
        <button
          id="deleteSelectedBtn"
          aria-label="Supprimer les vid√©os s√©lectionn√©es"
          style="
            background: #d32f2f;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 7px 16px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
            margin-right: 10px;
          "
        >
          üóëÔ∏è Supprimer les s√©lectionn√©es
        </button>
        <button
          id="saveBtn"
          aria-label="Sauvegarder les modifications"
          style="
            background: #e84e9b;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 7px 16px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
          "
        >
          üíæ Sauvegarder
        </button>
      </div>
    </div>

    <!-- Conteneur flex pour les deux cartouches -->
    <div
      style="
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        align-items: flex-start;
        margin: 18px 5vw 10px 5vw;
      "
    >
      <!-- Cartouche de filtre Niveau + Contenu -->
      <div
        class="cartouche"
        id="niveau-filter"
        role="complementary"
        aria-label="Filtres de recherche"
      >
        <div
          class="cartouche-header"
          style="background: linear-gradient(90deg, #fce86e 0%, #e84e9b 100%)"
        >
          <h3 style="margin: 0; font-size: inherit">FILTRES</h3>
        </div>
        <div class="cartouche-content">
          <!-- contenu du cartouche filtre (copi√© depuis l'ancien) -->
          <div
            style="
              display: flex;
              align-items: center;
              gap: 18px;
              margin-bottom: 2px;
            "
          >
            <span style="font-weight: bold; margin-right: 10px">Niveau :</span>
            <label style="display: flex; align-items: center; gap: 4px">
              <input
                type="checkbox"
                class="niveau-checkbox"
                value="Lyc√©e"
                style="accent-color: #e84e9b; width: 18px; height: 18px"
              />
              Lyc√©e
            </label>
            <label style="display: flex; align-items: center; gap: 4px">
              <input
                type="checkbox"
                class="niveau-checkbox"
                value="Coll√®ge"
                style="accent-color: #89d6e2; width: 18px; height: 18px"
              />
              Coll√®ge
            </label>
            <label style="display: flex; align-items: center; gap: 4px">
              <input
                type="checkbox"
                class="niveau-checkbox"
                value="Enseignants"
                style="accent-color: #fce86e; width: 18px; height: 18px"
              />
              Enseignants
            </label>
          </div>
          <div style="display: flex; align-items: center; gap: 18px">
            <span style="font-weight: bold; margin-right: 10px">Contenu :</span>
            <label style="display: flex; align-items: center; gap: 4px">
              <input
                type="checkbox"
                class="contenu-checkbox"
                value="M√©thodologie"
                style="accent-color: #e84e9b; width: 18px; height: 18px"
              />
              M√©thodologie
            </label>
            <label style="display: flex; align-items: center; gap: 4px">
              <input
                type="checkbox"
                class="contenu-checkbox"
                value="P√©dagogie"
                style="accent-color: #89d6e2; width: 18px; height: 18px"
              />
              P√©dagogie
            </label>
            <label style="display: flex; align-items: center; gap: 4px">
              <input
                type="checkbox"
                class="contenu-checkbox"
                value="Cours"
                style="accent-color: #fce86e; width: 18px; height: 18px"
              />
              Cours
            </label>
          </div>
        </div>
      </div>

      <!-- Cartouche Mot de passe -->
      <div
        class="cartouche"
        id="motdepasse-cartouche"
        role="complementary"
        aria-label="Demande de mot de passe"
      >
        <div
          class="cartouche-header"
          style="background: linear-gradient(90deg, #fce86e 0%, #89d6e2 100%)"
        >
          <h3 style="margin: 0; font-size: inherit">MOT DE PASSE</h3>
        </div>
        <div class="cartouche-content">
          <a
            href="#"
            onclick="demanderMotDePasse(); return false;"
            style="
              color: #e84e9b;
              text-decoration: underline;
              cursor: pointer;
              display: inline-block;
              text-align: center;
              width: 100%;
            "
          >
            Je demande mon mot de passe<br />pour acc√©der aux documents
            s√©curis√©s
          </a>
          <div
            style="
              font-size: 0.95em;
              color: #888;
              margin-top: 2px;
              text-align: center;
              width: 100%;
            "
          >
            Mail acad√©mique (ne sera ni conserv√© ni utilis√© √† des fins
            publicitaires)
          </div>
          <p
            style="
              font-size: 0.8em;
              color: #666;
              margin: 10px 0 0 0;
              text-align: center;
              width: 100%;
            "
          >
            Besoin d'aide pour utiliser le mot de passe ?
            <a
              href="https://youtu.be/LnpteggdkxU?si=IXWg0mrRBx4VuMTJ"
              target="_blank"
              style="color: #89d6e2; text-decoration: none"
            >
              Regarde cette vid√©o
            </a>
          </p>
        </div>
      </div>
    </div>

    <main role="main">
      <h2 class="sr-only">Catalogue de vid√©os √©ducatives</h2>
      <table
        id="videoTable"
        role="table"
        aria-label="Tableau des vid√©os √©ducatives organis√©es par niveau et contenu"
      >
        <thead>
          <tr>
            <th>
              <input
                type="checkbox"
                id="selectAllCheckbox"
                class="row-checkbox"
                title="Tout s√©lectionner"
                aria-label="S√©lectionner toutes les vid√©os"
              />
            </th>
            <th scope="col">Vid√©o</th>
            <th scope="col">Niveau</th>
            <th scope="col">Contenu</th>
            <th scope="col">Ressources (voir commentaires des vid√©os)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <div class="form-container" id="add-video-form" style="display: none">
        <input
          type="text"
          id="videoUrl"
          placeholder="URL de la vid√©o YouTube"
        />
        <input type="text" id="niveau" placeholder="Niveau" />
        <input type="text" id="contenu" placeholder="Contenu" />
        <input type="text" id="ressources" placeholder="Ressources" />
        <button onclick="addVideo()">Ajouter la vid√©o</button>
      </div>
    </main>

    <script>
      const tbody = document.getElementById("tableBody");

      function getYouTubeId(url) {
        try {
          const parsed = new URL(url);
          if (parsed.hostname === "youtu.be") return parsed.pathname.slice(1);
          if (parsed.hostname.includes("youtube.com")) {
            // G√©rer les YouTube Shorts
            if (parsed.pathname.startsWith("/shorts/")) {
              return parsed.pathname.split("/shorts/")[1];
            }
            // G√©rer les URLs YouTube classiques
            return parsed.searchParams.get("v");
          }
        } catch {
          return null;
        }
        return null;
      }

      function insertRow(videoUrl, niveau, contenu, ressources) {
        const id = getYouTubeId(videoUrl) || "";
        const row = document.createElement("tr");

        // Ajouter la case √† cocher pour la s√©lection multiple
        const tdCheckbox = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "row-checkbox";
        checkbox.dataset.videoUrl = videoUrl;
        // Ajouter le gestionnaire d'√©v√©nement pour la s√©lection par plage
        checkbox.addEventListener("click", handleCheckboxClick);
        tdCheckbox.appendChild(checkbox);

        // Ajouter le bouton de suppression de ligne
        const deleteRowBtn = document.createElement("button");
        deleteRowBtn.className = "delete-row-btn";
        deleteRowBtn.innerHTML = "√ó";
        deleteRowBtn.title = "Supprimer cette ligne";
        deleteRowBtn.onclick = () => confirmDeleteRow(row);

        const tdVideo = document.createElement("td");
        tdVideo.style.position = "relative"; // Pour positionner le bouton de suppression
        tdVideo.innerHTML = `
    <a href="${videoUrl}" target="_blank">
      <img class="thumb" src="https://img.youtube.com/vi/${id}/mqdefault.jpg" alt="Miniature vid√©o YouTube" loading="lazy" width="320" height="180">
    </a>
    <span class="edit-icon" style="cursor:pointer;display:block;margin-top:5px;color:#999;font-size:12px;" onclick="changeVideoUrl(this)">‚úèÔ∏è Modifier</span>
  `;

        // D√©sactiver l'√©dition de l'URL si pas connect√©
        const editIcon = tdVideo.querySelector(".edit-icon");
        if (editIcon) {
          editIcon.style.pointerEvents = "none";
          editIcon.style.opacity = "0.3";
        }

        const tdNiveau = document.createElement("td");
        tdNiveau.innerHTML = niveau;
        tdNiveau.contentEditable = true;

        const tdContenu = document.createElement("td");
        tdContenu.style.position = "relative"; // Pour positionner le bouton de drapeau
        tdContenu.innerHTML = contenu;
        tdContenu.contentEditable = true;

        // Ajouter le bouton d'ajout de drapeau
        const addFlagBtn = document.createElement("button");
        addFlagBtn.className = "add-flag-btn";
        addFlagBtn.innerHTML = "üèÅ";
        addFlagBtn.title = "Ajouter un drapeau";
        addFlagBtn.onclick = (e) => {
          e.stopPropagation();
          showFlagMenu(addFlagBtn, tdContenu);
        };
        tdContenu.appendChild(addFlagBtn);

        // Debug : v√©rifier que le bouton est cr√©√©
        console.log("Bouton drapeau cr√©√©:", addFlagBtn);

        const tdRessources = document.createElement("td");
        if (
          ressources &&
          ressources.startsWith &&
          ressources.startsWith('<div class="resource-container"')
        ) {
          // Si ressources est du HTML d√©j√† g√©n√©r√©, l'injecter directement
          tdRessources.innerHTML = ressources;
        } else {
          // Sinon, comportement normal (cr√©ation DOM)
          const resourceContainer = document.createElement("div");
          resourceContainer.className = "resource-container";

          const resourceTitleWrapper = document.createElement("div");
          resourceTitleWrapper.className = "resource-title-wrapper";
          resourceTitleWrapper.style.position = "relative"; // Permet de positionner la coche par rapport au titre

          const resourceTitle = document.createElement("div");
          resourceTitle.className = "resource-title";
          resourceTitle.contentEditable = true;
          resourceTitle.textContent = "Titre";
          resourceTitle.addEventListener("focusout", saveTable);

          // Bouton pour supprimer le titre principal
          const deleteTitleBtn = document.createElement("button");
          deleteTitleBtn.textContent = "‚ùå";
          deleteTitleBtn.className = "delete-btn";
          deleteTitleBtn.style.position = "absolute";
          deleteTitleBtn.style.top = "50%";
          deleteTitleBtn.style.right = "0px"; // Rapproche la coche √† droite du titre
          deleteTitleBtn.style.transform = "translateY(-50%)"; // Centre verticalement la coche
          deleteTitleBtn.style.display = "none"; // Cach√© par d√©faut
          deleteTitleBtn.onclick = () => {
            resourceTitleWrapper.remove(); // Supprime compl√®tement le conteneur du titre
            saveTable();
          };

          let hideTimeout;

          resourceTitleWrapper.addEventListener("mouseover", () => {
            clearTimeout(hideTimeout); // Annule le d√©lai si la souris revient sur le titre
            deleteTitleBtn.style.display = "flex";
          });

          resourceTitleWrapper.addEventListener("mouseout", () => {
            hideTimeout = setTimeout(() => {
              deleteTitleBtn.style.display = "none";
            }, 300); // D√©lai de 300ms avant de cacher la coche
          });

          // Emp√™che la coche de dispara√Ætre lorsqu'elle est survol√©e
          deleteTitleBtn.addEventListener("mouseover", () => {
            clearTimeout(hideTimeout); // Annule le d√©lai si la souris survole la coche
            deleteTitleBtn.style.display = "flex";
          });

          deleteTitleBtn.addEventListener("mouseout", () => {
            hideTimeout = setTimeout(() => {
              deleteTitleBtn.style.display = "none";
            }, 300); // D√©lai de 300ms avant de cacher la coche
          });

          // Afficher la coche uniquement au survol du titre ou de la coche elle-m√™me
          resourceTitleWrapper.addEventListener("mouseover", () => {
            deleteTitleBtn.style.display = "flex";
          });
          resourceTitleWrapper.addEventListener("mouseout", () => {
            deleteTitleBtn.style.display = "none";
          });

          resourceTitleWrapper.appendChild(resourceTitle);
          resourceTitleWrapper.appendChild(deleteTitleBtn);

          const dropZone = document.createElement("div");
          dropZone.className = "drop-zone";
          dropZone.textContent = ""; // Zone vide mais fonctionnelle

          resourceContainer.appendChild(resourceTitleWrapper);
          resourceContainer.appendChild(dropZone);
          tdRessources.appendChild(resourceContainer);
        }
        // Ajouter le bouton de suppression dans la cellule vid√©o
        tdVideo.appendChild(deleteRowBtn);

        row.append(tdCheckbox, tdVideo, tdNiveau, tdContenu, tdRessources);
        tbody.appendChild(row);

        // Appliquer les restrictions d'√©dition apr√®s l'ajout de la ligne
        disableEditing();

        // Drag & Drop
        tdRessources.addEventListener("dragover", (e) => {
          e.preventDefault();
          tdRessources.style.backgroundColor = "#ffe9f3";
        });

        tdRessources.addEventListener("dragleave", (e) => {
          e.preventDefault();
          tdRessources.style.backgroundColor = "#fafafa";
        });

        tdRessources.addEventListener("drop", (e) => {
          e.preventDefault();
          tdRessources.style.backgroundColor = "#fafafa";
          const files = e.dataTransfer.files;
          if (!files.length) return;

          Array.from(files).forEach((file) => {
            if (!file.type.startsWith("image/")) return;
            if (file.size > 2 * 1024 * 1024) {
              alert("Image trop lourde (> 2 Mo)");
              return;
            }

            const reader = new FileReader();
            reader.onload = () => {
              const block = document.createElement("div");
              block.className = "resource-block";

              const delBtn = document.createElement("button");
              delBtn.className = "delete-btn";
              delBtn.textContent = "‚ùå";
              delBtn.onclick = () => {
                block.remove();
                saveTable();
              };

              const img = document.createElement("img");
              img.src = reader.result;
              img.className = "resource-img";
              img.alt = "Ressource p√©dagogique";
              img.loading = "lazy";

              const caption = document.createElement("div");
              caption.className = "image-title";
              caption.contentEditable = true;
              caption.textContent = "Titre de l'image";
              caption.addEventListener("focusout", saveTable);

              block.appendChild(delBtn);
              block.appendChild(img);
              block.appendChild(caption);

              // Toujours cibler le bon resource-container et drop-zone
              const resourceContainer = tdRessources.querySelector(
                ".resource-container"
              );
              let dropZone = resourceContainer.querySelector(".drop-zone");
              // Si le drop-zone n'est pas le dernier enfant, on le replace
              if (dropZone && resourceContainer.lastElementChild !== dropZone) {
                resourceContainer.appendChild(dropZone);
              }
              if (resourceContainer && dropZone) {
                resourceContainer.insertBefore(block, dropZone);
              }

              saveTable();
              // R√©appliquer les restrictions apr√®s ajout d'image
              disableEditing();
            };
            reader.readAsDataURL(file); // Convertit automatiquement en Base64
          });
        });
      }

      function changeVideoUrl(el) {
        const td = el.closest("td");
        const oldUrl = td.querySelector("a").href;
        const newUrl = prompt("Nouvelle URL YouTube :", oldUrl);
        if (newUrl && getYouTubeId(newUrl)) {
          const newId = getYouTubeId(newUrl);
          td.innerHTML = `
      <a href="${newUrl}" target="_blank">
        <img class="thumb" src="https://img.youtube.com/vi/${newId}/mqdefault.jpg" alt="Miniature vid√©o YouTube" loading="lazy" width="320" height="180">
      </a>
      <span class="edit-icon" style="cursor:pointer;display:block;margin-top:5px;color:#999;font-size:12px;" onclick="changeVideoUrl(this)">‚úèÔ∏è Modifier</span>
    `;
          saveTable();
        } else {
          alert("URL YouTube invalide");
        }
      }

      // Fonction pour extraire l'URL d'un lien dans un √©l√©ment
      function extractLinkUrl(element) {
        const link = element.querySelector("a");
        return link ? link.href : null;
      }

      // Fonction pour extraire le texte d'un √©l√©ment (sans les balises HTML)
      function extractText(element) {
        const link = element.querySelector("a");
        if (link) {
          return link.textContent || link.innerText || "";
        }
        return element.textContent || element.innerText || "";
      }

      // Fonction pour v√©rifier si un √©l√©ment est dans la cellule vid√©o
      function isInVideoCell(element) {
        const td = element.closest("td");
        if (!td) return false;
        const row = td.closest("tr");
        if (!row) return false;
        // La cellule vid√©o est le deuxi√®me td (index 1, apr√®s la checkbox)
        const cells = Array.from(row.querySelectorAll("td"));
        const cellIndex = cells.indexOf(td);
        return cellIndex === 1; // Index 1 = cellule vid√©o
      }

      // Fonction pour ajouter/modifier un hyperlien sur une miniature vid√©o YouTube
      function editVideoThumbnailLink(element) {
        const encryptedUserId = localStorage.getItem("adminUserId");
        if (!encryptedUserId) return;

        // Trouver la cellule vid√©o et l'image
        let td;
        let img;
        let linkElement;

        if (element.classList && element.classList.contains("thumb")) {
          // Si c'est l'image elle-m√™me
          img = element;
          td = img.closest("td");
          linkElement = img.closest("a");
        } else if (isInVideoCell(element)) {
          // Si c'est la cellule enti√®re
          td = element.closest("td");
          img = td.querySelector(".thumb");
          linkElement = td.querySelector("a");
        } else {
          return;
        }

        if (!img || !td) return;

        const currentUrl = linkElement ? linkElement.href : "";
        const newUrl = prompt(
          "Entrez l'URL du lien (laissez vide pour supprimer) :",
          currentUrl
        );

        if (newUrl === null) return; // Annul√©

        // Sauvegarder l'ic√¥ne d'√©dition si elle existe
        const editIcon = td.querySelector(".edit-icon");

        if (newUrl.trim()) {
          // Cr√©er ou modifier le lien
          if (linkElement) {
            linkElement.href = newUrl.trim();
            linkElement.target = "_blank";
          } else {
            // Cr√©er un nouveau lien autour de l'image
            const newLink = document.createElement("a");
            newLink.href = newUrl.trim();
            newLink.target = "_blank";
            newLink.appendChild(img.cloneNode(true));
            img.replaceWith(newLink);
          }
        } else {
          // Supprimer le lien mais garder l'image
          if (linkElement) {
            const newImg = img.cloneNode(true);
            linkElement.replaceWith(newImg);
          }
        }

        saveTable();
      }

      // Fonction pour ajouter/modifier un hyperlien sur une miniature de ressource
      function editResourceImageLink(element) {
        const encryptedUserId = localStorage.getItem("adminUserId");
        if (!encryptedUserId) return;

        // Trouver l'image de ressource ou le resource-block
        let img;
        let resourceBlock;

        if (element.classList && element.classList.contains("resource-img")) {
          // Si c'est l'image elle-m√™me
          img = element;
          resourceBlock = element.closest(".resource-block");
        } else if (
          element.classList &&
          element.classList.contains("resource-block")
        ) {
          // Si c'est le bloc entier
          resourceBlock = element;
          img = resourceBlock.querySelector(".resource-img");
        } else {
          // Chercher le resource-block parent
          resourceBlock = element.closest(".resource-block");
          if (resourceBlock) {
            img = resourceBlock.querySelector(".resource-img");
          }
        }

        if (!img || !resourceBlock) return;

        // Trouver le lien existant (s'il y en a un)
        const linkElement = img.closest("a");
        const currentUrl = linkElement ? linkElement.href : "";

        const newUrl = prompt(
          "Entrez l'URL du lien (laissez vide pour supprimer) :",
          currentUrl
        );

        if (newUrl === null) return; // Annul√©

        if (newUrl.trim()) {
          // Cr√©er ou modifier le lien
          if (linkElement) {
            linkElement.href = newUrl.trim();
            linkElement.target = "_blank";
          } else {
            // Cr√©er un nouveau lien autour de l'image
            const newLink = document.createElement("a");
            newLink.href = newUrl.trim();
            newLink.target = "_blank";
            newLink.appendChild(img.cloneNode(true));
            img.replaceWith(newLink);
          }
        } else {
          // Supprimer le lien mais garder l'image
          if (linkElement) {
            const newImg = img.cloneNode(true);
            linkElement.replaceWith(newImg);
          }
        }

        saveTable();
      }

      // Fonction pour ajouter/modifier un hyperlien dans un titre (resource-title ou image-title)
      function editTitleLink(titleElement, event) {
        const encryptedUserId = localStorage.getItem("adminUserId");
        if (!encryptedUserId) return;

        // V√©rifier s'il y a une s√©lection de texte
        const selection = window.getSelection();
        let hasSelection = false;
        let selectedText = "";
        let range = null;

        if (selection.rangeCount > 0) {
          range = selection.getRangeAt(0);
          selectedText = range.toString().trim();

          // V√©rifier si la s√©lection est dans le titre
          // On v√©rifie si le conteneur commun ou les conteneurs de d√©but/fin sont dans le titre
          const commonAncestor = range.commonAncestorContainer;
          const startContainer = range.startContainer;
          const endContainer = range.endContainer;

          // Fonction pour v√©rifier si un n≈ìud est dans le titre
          const isInTitle = (node) => {
            if (!node) return false;
            // Si c'est un n≈ìud texte, v√©rifier son parent
            if (node.nodeType === Node.TEXT_NODE) {
              return titleElement.contains(node.parentNode);
            }
            // Sinon v√©rifier directement
            return titleElement.contains(node) || titleElement === node;
          };

          if (
            selectedText.length > 0 &&
            (isInTitle(commonAncestor) ||
              isInTitle(startContainer) ||
              isInTitle(endContainer) ||
              titleElement.contains(commonAncestor) ||
              titleElement.contains(startContainer) ||
              titleElement.contains(endContainer))
          ) {
            hasSelection = true;
          }
        }

        // Si pas de s√©lection, v√©rifier si on a cliqu√© sur un lien existant
        let clickedLink = null;
        if (!hasSelection && event && event.target) {
          clickedLink = event.target.closest("a");
          if (clickedLink && !titleElement.contains(clickedLink)) {
            clickedLink = null;
          }
        }

        const currentUrl = clickedLink
          ? clickedLink.href
          : hasSelection
          ? ""
          : titleElement.querySelector("a")
          ? titleElement.querySelector("a").href
          : "";

        const promptText = hasSelection
          ? `Entrez l'URL du lien pour "${selectedText}" (laissez vide pour supprimer) :`
          : clickedLink
          ? "Entrez l'URL du lien (laissez vide pour supprimer) :"
          : "Entrez l'URL du lien pour tout le titre (laissez vide pour supprimer) :";

        const newUrl = prompt(promptText, currentUrl);

        if (newUrl === null) return; // Annul√©

        if (hasSelection && range) {
          // Cr√©er un lien uniquement sur la s√©lection
          if (newUrl.trim()) {
            // Supprimer la s√©lection
            range.deleteContents();

            // Cr√©er le lien
            const link = document.createElement("a");
            link.href = newUrl.trim();
            link.target = "_blank";
            link.textContent = selectedText;

            // Ins√©rer le lien √† la position de la s√©lection
            range.insertNode(link);

            // Nettoyer la s√©lection
            selection.removeAllRanges();
          }
          // Si newUrl est vide, on ne fait rien (on supprime juste la s√©lection)
        } else if (clickedLink) {
          // Modifier ou supprimer le lien sur lequel on a cliqu√©
          if (newUrl.trim()) {
            clickedLink.href = newUrl.trim();
            clickedLink.target = "_blank";
          } else {
            // Remplacer le lien par son texte
            const text = clickedLink.textContent || clickedLink.innerText || "";
            clickedLink.replaceWith(document.createTextNode(text));
          }
        } else {
          // Comportement par d√©faut : cr√©er un lien sur tout le titre
          const currentLink = titleElement.querySelector("a");
          const currentText = extractText(titleElement);

          if (newUrl.trim()) {
            // Cr√©er ou modifier le lien
            if (currentLink) {
              currentLink.href = newUrl.trim();
              currentLink.target = "_blank";
            } else {
              // Cr√©er un nouveau lien autour du texte existant
              const text = currentText || titleElement.textContent || "";
              titleElement.innerHTML = `<a href="${newUrl.trim()}" target="_blank">${text}</a>`;
            }
          } else {
            // Supprimer le lien mais garder le texte
            if (currentLink) {
              const text =
                currentLink.textContent || currentLink.innerText || "";
              titleElement.innerHTML = text;
            }
          }
        }

        saveTable();
      }

      // Fonction pour g√©rer le menu contextuel (clic droit)
      function setupContextMenu() {
        document.addEventListener("contextmenu", function (e) {
          const encryptedUserId = localStorage.getItem("adminUserId");
          if (!encryptedUserId) return;

          // V√©rifier si c'est une miniature vid√©o YouTube (colonne Vid√©o)
          const thumb = e.target.closest(".thumb");
          if (thumb) {
            e.preventDefault();
            editVideoThumbnailLink(thumb);
            return;
          }

          // V√©rifier si c'est dans la cellule vid√©o (le "carr√©" de la miniature vid√©o)
          if (isInVideoCell(e.target)) {
            e.preventDefault();
            editVideoThumbnailLink(e.target);
            return;
          }

          // V√©rifier si c'est une image de ressource (miniature dans la colonne Ressources)
          const resourceImg = e.target.closest(".resource-img");
          if (resourceImg) {
            e.preventDefault();
            editResourceImageLink(resourceImg);
            return;
          }

          // V√©rifier si c'est un resource-block (le "carr√©" de la miniature)
          const resourceBlock = e.target.closest(".resource-block");
          if (resourceBlock) {
            e.preventDefault();
            editResourceImageLink(resourceBlock);
            return;
          }

          // V√©rifier si c'est un titre de ressource
          const resourceTitle = e.target.closest(".resource-title");
          if (resourceTitle) {
            e.preventDefault();
            editTitleLink(resourceTitle, e);
            return;
          }

          // V√©rifier si c'est un titre d'image
          const imageTitle = e.target.closest(".image-title");
          if (imageTitle) {
            e.preventDefault();
            editTitleLink(imageTitle, e);
            return;
          }
        });
      }

      // Fonction pour g√©rer le raccourci Ctrl+K
      function setupKeyboardShortcut() {
        document.addEventListener("keydown", function (e) {
          const encryptedUserId = localStorage.getItem("adminUserId");
          if (!encryptedUserId) return;

          // Ctrl+K ou Cmd+K
          if ((e.ctrlKey || e.metaKey) && e.key === "k") {
            e.preventDefault();

            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;

            // V√©rifier si la s√©lection est dans une miniature vid√©o YouTube
            const thumb =
              container.nodeType === Node.ELEMENT_NODE
                ? container.closest(".thumb")
                : container.parentElement?.closest(".thumb");
            if (thumb) {
              editVideoThumbnailLink(thumb);
              return;
            }

            // V√©rifier si la s√©lection est dans la cellule vid√©o
            const targetElement =
              container.nodeType === Node.ELEMENT_NODE
                ? container
                : container.parentElement;
            if (targetElement && isInVideoCell(targetElement)) {
              editVideoThumbnailLink(targetElement);
              return;
            }

            // V√©rifier si la s√©lection est dans une image de ressource
            const resourceImg =
              container.nodeType === Node.ELEMENT_NODE
                ? container.closest(".resource-img")
                : container.parentElement?.closest(".resource-img");
            if (resourceImg) {
              editResourceImageLink(resourceImg);
              return;
            }

            // V√©rifier si la s√©lection est dans un resource-block
            const resourceBlock =
              container.nodeType === Node.ELEMENT_NODE
                ? container.closest(".resource-block")
                : container.parentElement?.closest(".resource-block");
            if (resourceBlock) {
              editResourceImageLink(resourceBlock);
              return;
            }

            // V√©rifier si la s√©lection est dans un titre de ressource
            const resourceTitle =
              container.nodeType === Node.ELEMENT_NODE
                ? container.closest(".resource-title")
                : container.parentElement?.closest(".resource-title");
            if (resourceTitle) {
              editTitleLink(resourceTitle, null);
              return;
            }

            // V√©rifier si la s√©lection est dans un titre d'image
            const imageTitle =
              container.nodeType === Node.ELEMENT_NODE
                ? container.closest(".image-title")
                : container.parentElement?.closest(".image-title");
            if (imageTitle) {
              editTitleLink(imageTitle, null);
              return;
            }
          }
        });
      }

      // Initialiser les gestionnaires d'√©v√©nements
      setupContextMenu();
      setupKeyboardShortcut();

      function addVideo() {
        const url = document.getElementById("videoUrl").value.trim();
        const niveau = document.getElementById("niveau").value.trim();
        const contenu = document.getElementById("contenu").value.trim();
        const ressources = document.getElementById("ressources").value.trim();

        if (!getYouTubeId(url)) {
          alert("URL YouTube invalide");
          return;
        }

        insertRow(url, niveau, contenu, ressources);
        saveTable();

        document.getElementById("videoUrl").value = "";
        document.getElementById("niveau").value = "";
        document.getElementById("contenu").value = "";
        document.getElementById("ressources").value = "";
      }

      tbody.addEventListener("focusout", saveTable);

      // Fonction pour d√©sactiver l'√©dition sans masquer l'interface
      function disableEditing() {
        // D√©sactiver l'√©dition des cellules
        const editableCells = document.querySelectorAll("td[contenteditable]");
        editableCells.forEach((cell) => {
          cell.contentEditable = "false";
          cell.style.backgroundColor = "#f9f9f9";
          cell.style.cursor = "not-allowed";
        });

        // D√©sactiver les boutons de suppression
        const deleteButtons = document.querySelectorAll(".delete-btn");
        deleteButtons.forEach((btn) => {
          btn.style.pointerEvents = "none";
          btn.style.opacity = "0.3";
        });

        // D√©sactiver les boutons de suppression de ligne
        const deleteRowButtons = document.querySelectorAll(".delete-row-btn");
        deleteRowButtons.forEach((btn) => {
          btn.style.pointerEvents = "none";
          btn.style.opacity = "0.3";
          btn.style.display = "none";
        });

        // D√©sactiver les boutons d'ajout de drapeau
        const addFlagButtons = document.querySelectorAll(".add-flag-btn");
        addFlagButtons.forEach((btn) => {
          btn.style.pointerEvents = "none";
          btn.style.opacity = "0.3";
          btn.style.display = "none";
        });

        // Supprimer la classe admin-mode du body
        document.body.classList.remove("admin-mode");

        // D√©sactiver le drag & drop
        const resourceContainers = document.querySelectorAll(
          ".resource-container"
        );
        resourceContainers.forEach((container) => {
          container.style.pointerEvents = "none";
        });

        // D√©sactiver les ic√¥nes d'√©dition d'URL
        const editIcons = document.querySelectorAll(".edit-icon");
        editIcons.forEach((icon) => {
          icon.style.pointerEvents = "none";
          icon.style.opacity = "0.3";
          icon.style.display = "none";
        });

        // D√©sactiver le tri des lignes
        const tableBody = document.getElementById("tableBody");
        if (tableBody) {
          const sortableInstance = Sortable.get(tableBody);
          if (sortableInstance) {
            sortableInstance.destroy();
          }
        }

        // Masquer le bouton sauvegarder et le formulaire d'ajout
        const saveBtn = document.getElementById("saveBtn");
        const addVideoForm = document.getElementById("add-video-form");
        const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
        const selectAllCheckbox = document.getElementById("selectAllCheckbox");

        if (saveBtn) {
          saveBtn.style.display = "none";
        }
        if (addVideoForm) {
          addVideoForm.style.display = "none";
        }
        if (deleteSelectedBtn) {
          deleteSelectedBtn.style.display = "none";
        }
        if (selectAllCheckbox) {
          selectAllCheckbox.style.display = "none";
        }

        // Masquer toutes les cases √† cocher
        const rowCheckboxes = document.querySelectorAll(".row-checkbox");
        rowCheckboxes.forEach((checkbox) => {
          checkbox.style.display = "none";
        });
      }

      // Fonction pour activer l'√©dition
      function enableEditing() {
        // Activer l'√©dition des cellules
        const editableCells = document.querySelectorAll("td[contenteditable]");
        editableCells.forEach((cell) => {
          cell.contentEditable = "true";
          cell.style.backgroundColor = "";
          cell.style.cursor = "";
        });

        // Activer les boutons de suppression
        const deleteButtons = document.querySelectorAll(".delete-btn");
        deleteButtons.forEach((btn) => {
          btn.style.pointerEvents = "auto";
          btn.style.opacity = "1";
        });

        // Activer les boutons de suppression de ligne
        const deleteRowButtons = document.querySelectorAll(".delete-row-btn");
        deleteRowButtons.forEach((btn) => {
          btn.style.pointerEvents = "auto";
          btn.style.opacity = "1";
          btn.style.display = "none"; // Reste cach√© jusqu'au survol
        });

        // Activer les boutons d'ajout de drapeau
        const addFlagButtons = document.querySelectorAll(".add-flag-btn");
        console.log("Boutons drapeau trouv√©s:", addFlagButtons.length);
        addFlagButtons.forEach((btn) => {
          btn.style.pointerEvents = "auto";
          btn.style.opacity = "1";
          btn.style.display = "none"; // Reste cach√© jusqu'au survol
          console.log("Bouton drapeau activ√©:", btn);
        });

        // Ajouter la classe admin-mode au body
        document.body.classList.add("admin-mode");

        // Activer le drag & drop
        const resourceContainers = document.querySelectorAll(
          ".resource-container"
        );
        resourceContainers.forEach((container) => {
          container.style.pointerEvents = "auto";
        });

        // Activer les ic√¥nes d'√©dition d'URL
        const editIcons = document.querySelectorAll(".edit-icon");
        editIcons.forEach((icon) => {
          icon.style.pointerEvents = "auto";
          icon.style.opacity = "1";
          icon.style.display = "block";
        });

        // R√©activer le tri des lignes avec support du d√©placement multiple
        const tableBody = document.getElementById("tableBody");
        if (tableBody) {
          // D√©truire l'instance existante si elle existe
          const existingInstance = Sortable.get(tableBody);
          if (existingInstance) {
            existingInstance.destroy();
          }

          // Variable pour stocker les lignes coch√©es √† d√©placer
          let selectedRowsForDrag = [];
          // Variable pour le d√©filement automatique bas√© sur le d√©placement
          let draggedRow = null;
          let lastDraggedRowIndex = -1;
          let scrollCheckInterval = null;

          new Sortable(tableBody, {
            animation: 150,
            handle: "td",
            onStart: function (evt) {
              // Arr√™ter tout d√©filement en cours
              if (scrollCheckInterval) {
                clearInterval(scrollCheckInterval);
                scrollCheckInterval = null;
              }

              // V√©rifier si la ligne d√©plac√©e a une case coch√©e
              draggedRow = evt.item;

              // Stocker l'index initial de la ligne
              const allRows = Array.from(tableBody.querySelectorAll("tr"));
              lastDraggedRowIndex = allRows.indexOf(draggedRow);

              // D√©marrer la v√©rification p√©riodique de l'index
              scrollCheckInterval = setInterval(function () {
                if (!draggedRow || !draggedRow.parentNode) {
                  // La ligne n'existe plus, arr√™ter la v√©rification
                  if (scrollCheckInterval) {
                    clearInterval(scrollCheckInterval);
                    scrollCheckInterval = null;
                  }
                  return;
                }

                // Obtenir l'index actuel de la ligne
                const allRows = Array.from(tableBody.querySelectorAll("tr"));
                const currentIndex = allRows.indexOf(draggedRow);

                // Si l'index a chang√©
                if (
                  currentIndex !== lastDraggedRowIndex &&
                  currentIndex !== -1
                ) {
                  // Calculer la diff√©rence
                  const indexDiff = currentIndex - lastDraggedRowIndex;

                  // Obtenir la hauteur approximative d'une ligne
                  const rowHeight = draggedRow.offsetHeight || 50;

                  // Calculer la distance de d√©filement (une ligne)
                  const scrollAmount = indexDiff * rowHeight;

                  // Faire d√©filer
                  window.scrollBy({
                    top: scrollAmount,
                    behavior: "auto",
                  });

                  // Mettre √† jour l'index de r√©f√©rence
                  lastDraggedRowIndex = currentIndex;
                }
              }, 100); // V√©rifier toutes les 100ms
              const draggedCheckbox = draggedRow.querySelector(
                ".row-checkbox:not(#selectAllCheckbox)"
              );

              // R√©initialiser la liste des lignes √† d√©placer
              selectedRowsForDrag = [];

              if (draggedCheckbox && draggedCheckbox.checked) {
                // Collecter toutes les lignes coch√©es (sauf celle qui est d√©j√† en train d'√™tre d√©plac√©e)
                // et conserver leur ordre original
                const allRows = Array.from(tableBody.querySelectorAll("tr"));
                allRows.forEach((row) => {
                  if (row !== draggedRow) {
                    const checkbox = row.querySelector(
                      ".row-checkbox:not(#selectAllCheckbox)"
                    );
                    if (checkbox && checkbox.checked) {
                      // Stocker avec l'index original pour pr√©server l'ordre
                      selectedRowsForDrag.push({
                        row: row,
                        originalIndex: allRows.indexOf(row),
                      });
                    }
                  }
                });

                // Trier par index original pour pr√©server l'ordre
                selectedRowsForDrag.sort(
                  (a, b) => a.originalIndex - b.originalIndex
                );
              }
            },
            onEnd: function (evt) {
              // Arr√™ter la v√©rification p√©riodique
              if (scrollCheckInterval) {
                clearInterval(scrollCheckInterval);
                scrollCheckInterval = null;
              }

              const draggedRowLocal = evt.item;

              // R√©initialiser la variable globale
              draggedRow = null;
              lastDraggedRowIndex = -1;

              const draggedCheckbox = draggedRowLocal.querySelector(
                ".row-checkbox:not(#selectAllCheckbox)"
              );

              // Si la ligne d√©plac√©e est coch√©e et qu'il y a d'autres lignes coch√©es
              if (
                draggedCheckbox &&
                draggedCheckbox.checked &&
                selectedRowsForDrag.length > 0
              ) {
                // Retirer toutes les autres lignes coch√©es de leur position actuelle
                const rowsToMove = [];
                selectedRowsForDrag.forEach((rowData) => {
                  const row = rowData.row;
                  // V√©rifier que la ligne existe encore dans le DOM
                  if (row.parentNode === tableBody) {
                    rowsToMove.push(row);
                    row.remove();
                  }
                });

                // Ins√©rer toutes les lignes coch√©es juste apr√®s la ligne principale d√©plac√©e
                // Cela les regroupe toutes ensemble, dans l'ordre original
                if (rowsToMove.length > 0) {
                  // Trouver le prochain √©l√©ment apr√®s la ligne d√©plac√©e
                  const nextSibling = draggedRowLocal.nextSibling;

                  // Ins√©rer toutes les lignes coch√©es une par une apr√®s la ligne principale
                  // L'ordre est pr√©serv√© gr√¢ce au tri effectu√© dans onStart
                  rowsToMove.forEach((row) => {
                    tableBody.insertBefore(row, nextSibling);
                  });
                }
              }

              // R√©initialiser
              selectedRowsForDrag = [];

              saveTable();
            },
          });
        }

        // Afficher le bouton sauvegarder et le formulaire d'ajout
        const saveBtn = document.getElementById("saveBtn");
        const addVideoForm = document.getElementById("add-video-form");
        const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
        const selectAllCheckbox = document.getElementById("selectAllCheckbox");

        if (saveBtn) {
          saveBtn.style.display = "inline-block";
        }
        if (addVideoForm) {
          addVideoForm.style.display = "block";
        }
        if (deleteSelectedBtn) {
          deleteSelectedBtn.style.display = "inline-block";
        }
        if (selectAllCheckbox) {
          selectAllCheckbox.style.display = "block";
        }

        // Afficher toutes les cases √† cocher
        const rowCheckboxes = document.querySelectorAll(".row-checkbox");
        rowCheckboxes.forEach((checkbox) => {
          if (checkbox.id !== "selectAllCheckbox") {
            checkbox.style.display = "block";
          }
        });
      }

      // Charger les donn√©es au d√©marrage
      document.addEventListener("DOMContentLoaded", function () {
        // loadTable() g√®re maintenant l'√©tat des boutons
        loadTable();
      });

      // Fonction de chiffrement simple
      function encrypt(text) {
        return btoa(text.split("").reverse().join(""));
      }

      function decrypt(encrypted) {
        return atob(encrypted).split("").reverse().join("");
      }

      document.getElementById("connectBtn").onclick = async function () {
        const userId = prompt("Veuillez entrer votre identifiant :");
        if (userId && userId.trim()) {
          // V√©rifier que l'identifiant est autoris√© (double chiffrement)
          const expectedId = encrypt("michawaro4480");
          if (encrypt(userId.trim()) === expectedId) {
            // Demander le mot de passe
            const password = prompt("Veuillez entrer votre mot de passe :");
            const expectedPassword = encrypt("4480Svt4426");
            if (password && encrypt(password.trim()) === expectedPassword) {
              // Chiffrer l'ID avant de le sauvegarder
              const encryptedUserId = encrypt(userId.trim());
              localStorage.setItem("adminUserId", encryptedUserId);
              document.getElementById("userId").value = userId.trim();
              // Recharger les donn√©es avec le bon userId et activer l'√©dition
              loadTable();
            } else {
              alert("Mot de passe incorrect. Acc√®s refus√©.");
              // Supprimer l'ID chiffr√© du localStorage
              localStorage.removeItem("adminUserId");
              document.getElementById("userId").value = "";
              loadTable();
            }
          } else {
            alert(
              "Identifiant non autoris√©. Seul l'administrateur peut acc√©der √† cette page."
            );
            // Supprimer l'ID chiffr√© du localStorage
            localStorage.removeItem("adminUserId");
            document.getElementById("userId").value = "";
            loadTable();
          }
        }
      };

      // Fonction de d√©connexion
      function logout() {
        // Supprimer l'ID chiffr√© du localStorage
        localStorage.removeItem("adminUserId");
        document.getElementById("userId").value = "";
        loadTable();
      }

      // Style pour la fen√™tre de confirmation
      const style = document.createElement("style");
      style.textContent = `
        .confirmation-dialog {
          position: absolute;
          background: #e8f5e9; /* Vert p√¢le */
          padding: 15px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          z-index: 1000;
          display: none;
          min-width: 200px;
        }
        .confirmation-dialog p {
          margin: 0 0 10px 0;
          color: #333;
        }
        .confirmation-dialog button {
          padding: 5px 15px;
          margin: 0 5px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-weight: bold;
        }
        .confirmation-dialog .yes-btn {
          background: #4caf50;
          color: white;
        }
        .confirmation-dialog .no-btn {
          background: #8bc34a;
          color: white;
        }
      `;
      document.head.appendChild(style);

      // Fonction pour cr√©er et afficher la fen√™tre de confirmation
      function showConfirmationDialog() {
        // Cr√©er la fen√™tre
        const confirmationDialog = document.createElement("div");
        confirmationDialog.className = "confirmation-dialog";
        confirmationDialog.innerHTML = `
          <p>C'est fait Bro, rester connect√© ?</p>
          <button class="yes-btn" onclick="closeConfirmationDialog()">Oui</button>
          <button class="no-btn" onclick="closeConfirmationDialog()">Non</button>
        `;

        // Ajouter les √©couteurs d'√©v√©nements pour les boutons
        const yesBtn = confirmationDialog.querySelector(".yes-btn");
        const noBtn = confirmationDialog.querySelector(".no-btn");

        yesBtn.addEventListener("click", closeConfirmationDialog);
        noBtn.addEventListener("click", function () {
          closeConfirmationDialog();
          logout();
        });

        // Ins√©rer la fen√™tre dans le body
        document.body.appendChild(confirmationDialog);

        // Positionner la fen√™tre juste sous le bouton sauvegarder
        const saveBtn = document.getElementById("saveBtn");
        if (saveBtn) {
          const rect = saveBtn.getBoundingClientRect();
          const style = confirmationDialog.style;
          style.display = "block";
          style.top = rect.top + rect.height + window.scrollY + "px";
          style.left = rect.left + window.scrollX + "px";
        }
      }

      // Fonction pour fermer la fen√™tre
      function closeConfirmationDialog() {
        const dialog = document.querySelector(".confirmation-dialog");
        if (dialog) {
          dialog.style.display = "none";
          // Supprimer la fen√™tre apr√®s fermeture
          dialog.remove();
        }
      }

      document.getElementById("saveBtn").onclick = async function () {
        await saveToSupabase();
        // Cr√©er et afficher la fen√™tre de confirmation apr√®s la sauvegarde
        setTimeout(showConfirmationDialog, 500);
      };

      // Gestionnaire pour le bouton "Supprimer les s√©lectionn√©es"
      const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
      if (deleteSelectedBtn) {
        deleteSelectedBtn.onclick = deleteSelectedRows;
      }

      // Gestionnaire pour la case "Tout s√©lectionner"
      const selectAllCheckbox = document.getElementById("selectAllCheckbox");
      if (selectAllCheckbox) {
        selectAllCheckbox.onchange = toggleSelectAll;
      }
    </script>
    <!-- --- FILTRE NIVEAU + CONTENU --- -->
    <script>
      function filtrerParNiveauEtContenu() {
        // Niveaux
        const checkboxesNiveau = document.querySelectorAll(".niveau-checkbox");
        const niveauxAffiches = Array.from(checkboxesNiveau)
          .filter((cb) => cb.checked)
          .map((cb) => cb.value);
        // Contenus
        const checkboxesContenu =
          document.querySelectorAll(".contenu-checkbox");
        const contenusAffiches = Array.from(checkboxesContenu)
          .filter((cb) => cb.checked)
          .map((cb) => cb.value.toUpperCase());

        // Si aucun filtre n'est coch√©, tout s'affiche
        if (niveauxAffiches.length === 0 && contenusAffiches.length === 0) {
          document.querySelectorAll("#tableBody tr").forEach((row) => {
            row.style.display = "";
          });
          return;
        }

        // Pour chaque ligne du tableau
        document.querySelectorAll("#tableBody tr").forEach((row) => {
          // La premi√®re colonne est maintenant la case √† cocher, donc niveau est √† l'index 2 et contenu √† l'index 3
          const niveauCell = row.cells[2];
          const contenuCell = row.cells[3];
          if (!niveauCell || !contenuCell) return;
          const niveauTexte = niveauCell.textContent || "";
          const contenuTexte = (contenuCell.textContent || "").toUpperCase();

          // Filtrage Niveau
          let visibleNiveau = true;
          if (niveauxAffiches.length > 0) {
            visibleNiveau = niveauxAffiches.some((niv) =>
              niveauTexte.includes(niv)
            );
          }

          // Filtrage Contenu
          let visibleContenu = true;
          if (contenusAffiches.length > 0) {
            visibleContenu = contenusAffiches.some((cont) =>
              contenuTexte.includes(cont)
            );
          }

          row.style.display = visibleNiveau && visibleContenu ? "" : "none";
        });
      }
      document
        .querySelectorAll(".niveau-checkbox, .contenu-checkbox")
        .forEach((cb) => {
          cb.addEventListener("change", filtrerParNiveauEtContenu);
        });
      document.addEventListener("DOMContentLoaded", filtrerParNiveauEtContenu);
    </script>
    <!-- EmailJS : initialisation et fonction d'envoi du mot de passe -->
    <script>
      (function () {
        emailjs.init("xdA52HKPTBkJ8z4y-");
      })();

      function demanderMotDePasse() {
        const email = prompt("Entrez votre adresse mail acad√©mique :");
        // V√©rification du format prenom.nom@ac-academie.fr
        const regex = /^[a-zA-Z]+\.[a-zA-Z]+@ac-[a-zA-Z]+\.fr$/;
        if (!regex.test(email)) {
          alert(
            "Adresse non valide. Utilisez votre adresse acad√©mique (prenom.nom@ac-academie.fr)"
          );
          return;
        }
        // Envoi du mail via EmailJS
        emailjs
          .send("service_054acwk", "template_4o097td", {
            to_email: email,
          })
          .then(
            function (response) {
              alert(
                "Le mot de passe a √©t√© envoy√© √† votre adresse acad√©mique !"
              );
            },
            function (error) {
              alert("Erreur lors de l'envoi du mail. Veuillez r√©essayer.");
            }
          );
      }
    </script>
  </body>
</html>
